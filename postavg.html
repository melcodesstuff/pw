<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PW Post Averages</title>
  <link rel="icon" type="image/png" href="witch-hat.png">
  <!-- Site styles to match index/terms aesthetic -->
  <link rel="stylesheet" href="styles.css">
  <!-- Tailwind for form/layout utilities used in the calculator -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header" style="margin-bottom:1rem;">
      <div>
        <h1 class="title">PW Post Averages</h1>
        <p class="subtitle">Unofficial calculator for per-term averages and eligibility across your characters.</p>
      </div>
      <a class="theme-toggle home-link" href="index.html" aria-label="Go to home">
        <span class="icon" aria-hidden="true">üè∞</span>
        Home
      </a>
    </header>

    <!-- React app mounts here -->
    <div id="root"></div>

    <footer class="footer" style="margin-top:2rem;">
      <p>Unofficial Potterworld utilities ‚Ä¢ Made by ‚ú® mel for the community</p>
    </footer>
  </div>

  <!-- React 18 + ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Load shared timeline so 2+ year logic works across all terms -->
  <script src="terms-data.js"></script>

  <script type="text/babel">
    const { useMemo, useState } = React;

    // ---------- Utilities ----------
    const todayISO = () => new Date().toISOString().slice(0, 10);
    function parseISO(s) { const [y, m, d] = s.split("-").map(Number); return new Date(y, m - 1, d); }
    function addYears(d, n) { const x = new Date(d); x.setFullYear(x.getFullYear() + n); return x; }
    function uid() { return Math.random().toString(36).slice(2, 9); }
    function clampInt(n, min, max) { const v = typeof n === "number" ? n : parseInt(String(n || 0), 10); if (Number.isNaN(v)) return min; return Math.max(min, Math.min(max, v)); }
    function formatAvg(n) { if (n == null || Number.isNaN(n)) return "‚Äî"; return Number.isInteger(n) ? String(n) : n.toFixed(2); }

    // ---------- Build TERM_MAP from shared PW_TERMS (fallback if missing) ----------
    const TERM_MAP = (() => {
      const list = Array.isArray(window.PW_TERMS) ? window.PW_TERMS : [];
      if (list.length) {
        const toISO = d => {
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          return `${y}-${m}-${day}`;
        };
        return list.reduce((acc, t) => {
          acc[t.term] = { start: toISO(t.startDate), end: toISO(t.endDate) };
          return acc;
        }, {});
      }
      // Minimal fallback so the page still works without terms-data.js
      return {
        167: { start: "2024-02-24", end: "2024-04-05" },
        168: { start: "2024-04-06", end: "2024-05-17" },
        169: { start: "2024-05-18", end: "2024-06-29" },
        170: { start: "2024-07-06", end: "2024-08-16" },
        171: { start: "2024-08-17", end: "2024-09-28" },
        172: { start: "2024-10-05", end: "2024-11-15" },
        173: { start: "2024-11-16", end: "2024-12-28" },
        174: { start: "2025-01-04", end: "2025-02-14" },
        175: { start: "2025-02-15", end: "2025-03-28" },
        176: { start: "2025-04-05", end: "2025-05-16" },
        177: { start: "2025-05-17", end: "2025-06-28" },
        178: { start: "2025-07-05", end: "2025-08-15" },
      };
    })();

    // ---------- UI helpers ----------
    function Badge({ ok, pending=false, children }) {
      const base = 'inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border';
      const cls = pending
        ? 'bg-slate-100 text-slate-700 border-slate-200'
        : ok
          ? 'bg-emerald-100 text-emerald-900 border-emerald-200'
          : 'bg-rose-100 text-rose-900 border-rose-200';
      return <span className={`${base} ${cls}`}>{children}</span>;
    }

    // ---------- App ----------
    function App() {
      const today = todayISO();

      const currentTerm = useMemo(() => {
        const td = parseISO(today);
        // try to find by date
        for (const [tStr, range] of Object.entries(TERM_MAP)) {
          const s = parseISO(range.start);
          const e = parseISO(range.end);
          if (td >= s && td <= e) return Number(tStr);
        }
        // else pick the highest term we know about
        return Math.max(...Object.keys(TERM_MAP).map(Number));
      }, [today]);

      function blankChar() {
        return {
          id: uid(),
          name: "",
          joinedTerm: "",
          isAdultCreated: false,
          isSpirit: false,
          currentPosts: "",
          graduationCount: "",
          hasAdultCheck: false,
          adultCheckTerm: "",
          adultCheckPostCount: "",
        };
      }

      const [characters, setCharacters] = useState([blankChar(), blankChar()]);

      function updateChar(id, patch) { setCharacters(prev => prev.map(c => (c.id === id ? { ...c, ...patch } : c))); }
      function addChar() { if (characters.length >= 10) return; setCharacters(prev => [...prev, blankChar()]); }
      function removeChar(id) { setCharacters(prev => prev.filter(c => c.id !== id)); }
      function clearChar(id) { setCharacters(prev => prev.map(c => c.id === id ? blankChar() : c)); }
      function clearAll() { setCharacters([blankChar(), blankChar()]); }

      function computeChar(c) {
        let termsOnBoard = null;
        if (typeof c.joinedTerm === "number") {
          termsOnBoard = currentTerm - c.joinedTerm + 1;
          if (termsOnBoard < 1) termsOnBoard = null;
        }

        // Hogwarts vs AW
        let stage = "";
        let hogwartsYear = null;
        let awTerms = null;
        if (typeof c.joinedTerm === "number") {
          if (c.isAdultCreated) {
            stage = "AW";
            awTerms = termsOnBoard ?? null;
          } else if (termsOnBoard != null) {
            if (termsOnBoard <= 7) { stage = "Hogwarts"; hogwartsYear = termsOnBoard; }
            else { stage = "AW"; awTerms = termsOnBoard - 7; }
          }
        }

        // RL years windows (needs TERM_MAP range)
        let twoPlusYears = false, twoPlusAmbiguous = false, onePlusYears = false;
        if (typeof c.joinedTerm === "number" && TERM_MAP[c.joinedTerm]) {
          const { start, end } = TERM_MAP[c.joinedTerm];
          const start2y = addYears(parseISO(start), 2);
          const end2y   = addYears(parseISO(end), 2);
          const end1y   = addYears(parseISO(end), 1);
          const td = parseISO(today);
          if (td >= end2y) twoPlusYears = true;
          else if (td >= start2y && td < end2y) twoPlusAmbiguous = true;
          if (td >= end1y) onePlusYears = true;
        }

        const minRequired = c.isSpirit ? 0 : (twoPlusYears ? 10 : 20);

        const posts = c.currentPosts === "" ? null : Number(c.currentPosts);
        const perTermAvg = (posts != null && termsOnBoard && termsOnBoard > 0) ? (posts / termsOnBoard) : null;

        const grad = typeof c.graduationCount === "number" ? Number(c.graduationCount) : null;
        const hogwartsAvgPerTerm = grad != null ? grad / 7 : null;
        const awAvgPerTerm = (stage === "AW" && grad != null && posts != null && awTerms && awTerms > 0 && posts >= grad)
          ? (posts - grad) / awTerms : null;

        let sinceAdultCheckAvg = null;
        if (stage === "AW" && c.hasAdultCheck && typeof c.adultCheckTerm === "number" && typeof c.adultCheckPostCount === "number" && posts != null) {
          const termsSince = Math.max(1, currentTerm - c.adultCheckTerm + 1);
          const delta = posts - c.adultCheckPostCount;
          if (termsSince > 0 && delta >= 0) sinceAdultCheckAvg = delta / termsSince;
        }

        return { termsOnBoard, stage, hogwartsYear, awTerms, twoPlusYears, twoPlusAmbiguous, onePlusYears, minRequired, perTermAvg, hogwartsAvgPerTerm, awAvgPerTerm, sinceAdultCheckAvg };
      }

      const computed = useMemo(() => {
        const map = {}; characters.forEach(c => { map[c.id] = computeChar(c); }); return map;
      }, [characters, currentTerm, today]);

      function effectiveAvg(c, pc) {
        if (!pc) return null;
        if (pc.stage === 'AW') {
          if (pc.sinceAdultCheckAvg != null) return pc.sinceAdultCheckAvg;
          if (pc.awAvgPerTerm != null) return pc.awAvgPerTerm;
        }
        return pc.perTermAvg;
      }

      return (
        <div>
          {/* Context (tight padding) */}
          <section className="grid grid-cols-1 md:grid-cols-3 gap-4 bg-white rounded-2xl p-4 shadow-sm border border-slate-200/60 mb-6">
            <div>
              <div className="text-xs uppercase tracking-wide text-slate-500">Today</div>
              <div className="mt-1 text-base font-medium">{today}</div>
            </div>
            <div>
              <div className="text-xs uppercase tracking-wide text-slate-500">Current term</div>
              <div className="mt-1 text-base font-medium">{currentTerm}</div>
            </div>
            <div className="text-xs text-slate-500 md:col-span-1 col-span-3">Based on embedded PW timeline for recent terms.</div>
          </section>

          {/* Characters (reduced vertical gap + shorter inputs) */}
          <div className="space-y-4">
            {characters.map((c, idx) => {
              const pc = computed[c.id];
              const inAW = pc?.stage === "AW";
              const showGradField = inAW && !c.isAdultCreated;
              return (
                <section key={c.id} className="relative rounded-2xl border p-4 shadow-sm bg-white border-slate-200/60">
                  <div className="absolute right-5 top-4 text-xs text-slate-500">Character {idx + 1}</div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-x-5 gap-y-2">
                    <div>
                      <label className="text-xs uppercase tracking-wide text-slate-500">Character name</label>
                      <input value={c.name} onChange={e => updateChar(c.id, { name: e.target.value })} className="w-full mt-0.5 px-3 h-9 rounded-xl bg-slate-100 outline-none" />
                    </div>

                    <div>
                      <label className="text-xs uppercase tracking-wide text-slate-500">What term did they join?</label>
                      <input type="number" value={c.joinedTerm} onChange={e => updateChar(c.id, { joinedTerm: e.target.value === "" ? "" : clampInt(e.target.value, 1, 999) })} className="w-full mt-0.5 px-3 h-9 rounded-xl bg-slate-100 outline-none" />
                      <p className="text-xs mt-0.5 text-slate-500">Terms on board: <span className="font-medium">{pc?.termsOnBoard ?? "‚Äî"}</span></p>
                    </div>

                    <div className="flex items-center gap-4">
                      <label className="flex items-center gap-2 text-sm text-slate-700"><input type="checkbox" className="accent-indigo-600" checked={c.isAdultCreated} onChange={e => updateChar(c.id, { isAdultCreated: e.target.checked })}/> Adult character</label>
                      <label className="flex items-center gap-2 text-sm text-slate-700"><input type="checkbox" className="accent-indigo-600" checked={c.isSpirit} onChange={e => updateChar(c.id, { isSpirit: e.target.checked })}/> Spirit character</label>
                    </div>

                    <div>
                      <label className="text-xs uppercase tracking-wide text-slate-500">Current post count</label>
                      <input type="number" value={c.currentPosts} onChange={e => updateChar(c.id, { currentPosts: e.target.value === "" ? "" : clampInt(e.target.value, 0, 1000000) })} className="w-full mt-0.5 px-3 h-9 rounded-xl bg-slate-100 outline-none" />
                      <div className="text-xs mt-0.5 text-slate-500">
                        Minimum required: <span className="font-medium">{pc?.minRequired ?? "‚Äî"}</span>
                        {pc?.sinceAdultCheckAvg != null && <> ‚Ä¢ Since check avg: <span className="font-medium">{formatAvg(pc.sinceAdultCheckAvg)}</span></>}
                        {pc?.perTermAvg != null && <> ‚Ä¢ Overall avg: <span className="font-medium">{formatAvg(pc.perTermAvg)}</span></>}
                        {pc?.twoPlusAmbiguous && <span className="ml-2 px-1.5 py-0.5 rounded bg-amber-200 text-amber-900">check 2y date</span>}
                      </div>
                    </div>

                    {showGradField && (
                      <div>
                        <label className="text-xs uppercase tracking-wide text-slate-500">Graduation post count (end of Hogwarts)</label>
                        <input type="number" value={c.graduationCount} onChange={e => updateChar(c.id, { graduationCount: e.target.value === "" ? "" : clampInt(e.target.value, 0, 1000000) })} className="w-full mt-0.5 px-3 h-9 rounded-xl bg-slate-100 outline-none" />
                      </div>
                    )}

                    {inAW && (
                      <>
                        <div>
                          <label className="text-xs uppercase tracking-wide text-slate-500">{c.isAdultCreated ? 'Adult check after registration?' : 'Adult check after graduation?'}</label>
                          <select value={c.hasAdultCheck ? "yes" : "no"} onChange={e => updateChar(c.id, { hasAdultCheck: e.target.value === "yes", adultCheckTerm: e.target.value === "yes" ? c.adultCheckTerm : "", adultCheckPostCount: e.target.value === "yes" ? c.adultCheckPostCount : "" })} className="w-full mt-0.5 px-3 h-9 rounded-xl bg-slate-100 outline-none"><option value="no">No</option><option value="yes">Yes</option></select>
                        </div>
                        {c.hasAdultCheck && (
                          <>
                            <div>
                              <label className="text-xs uppercase tracking-wide text-slate-500">Adult check term</label>
                              <input type="number" value={c.adultCheckTerm} onChange={e => updateChar(c.id, { adultCheckTerm: e.target.value === "" ? "" : clampInt(e.target.value, 1, 999) })} className="w-full mt-0.5 px-3 h-9 rounded-xl bg-slate-100 outline-none" />
                            </div>
                            <div>
                              <label className="text-xs uppercase tracking-wide text-slate-500">Adult check post count</label>
                              <input type="number" value={c.adultCheckPostCount} onChange={e => updateChar(c.id, { adultCheckPostCount: e.target.value === "" ? "" : clampInt(e.target.value, 0, 1000000) })} className="w-full mt-0.5 px-3 h-9 rounded-xl bg-slate-100 outline-none" />
                            </div>
                          </>
                        )}
                      </>
                    )}
                  </div>

                  {/* Per-character Summary */}
                  <div className="mt-3 rounded-xl bg-slate-50 border border-slate-200/60 p-3 text-sm">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <div><div className="text-slate-500">Terms on board</div><div className="font-medium">{pc?.termsOnBoard ?? "‚Äî"}</div></div>
                      <div><div className="text-slate-500">AW terms</div><div className="font-medium">{pc?.awTerms ?? 0}</div></div>
                      <div><div className="text-slate-500">Posts overall</div><div className="font-medium">{c.currentPosts === "" ? "‚Äî" : c.currentPosts}</div></div>
                      <div><div className="text-slate-500">Overall avg/term</div><div className="font-medium">{pc?.perTermAvg != null ? formatAvg(pc.perTermAvg) : "‚Äî"}</div></div>
                      <div><div className="text-slate-500">Hogwarts avg/term</div><div className="font-medium">{pc?.hogwartsAvgPerTerm != null ? formatAvg(pc.hogwartsAvgPerTerm) : "‚Äî"}</div></div>
                      <div><div className="text-slate-500">AW avg/term</div><div className="font-medium">{pc?.awAvgPerTerm != null ? formatAvg(pc.awAvgPerTerm) : "‚Äî"}</div></div>
                      {pc?.sinceAdultCheckAvg != null && (
                        <div className="md:col-span-3"><div className="text-slate-500">Since adult check avg/term</div><div className="font-medium">{formatAvg(pc.sinceAdultCheckAvg)}</div></div>
                      )}
                    </div>
                  </div>

                  <div className="mt-3 flex flex-wrap gap-2 justify-end items-center">
                    <div className="flex gap-2">
                      <button onClick={() => clearChar(c.id)} className="px-3 py-2 rounded-xl bg-slate-200">Clear</button>
                      <button onClick={() => removeChar(c.id)} className="px-3 py-2 rounded-xl bg-slate-200">Remove</button>
                    </div>
                  </div>
                </section>
              );
            })}

            <div className="flex gap-3 items-center">
              <button onClick={addChar} disabled={characters.length >= 10} className="px-4 py-2 rounded-xl bg-indigo-600 text-white disabled:opacity-40">Add character</button>
              <div className="text-sm text-slate-500">{characters.length}/10</div>
              <button onClick={clearAll} className="ml-auto px-4 py-2 rounded-xl bg-rose-600 text-white">Clear all</button>
            </div>
          </div>

          {/* Summary (no rules block) */}
          <section className="mt-6 rounded-2xl border p-4 shadow-sm bg-white border-slate-200/60">
            <h2 className="text-lg font-semibold mb-2">Summary</h2>
            <Summary characters={characters} computed={computed} effectiveAvg={effectiveAvg} />
          </section>

          {/* Twins */}
          <Twins characters={characters} computed={computed} effectiveAvg={effectiveAvg} />

          {/* 7th+ / 8+ / 9+ */}
          <PlusEligibility characters={characters} computed={computed} effectiveAvg={effectiveAvg} />

          {/* Adult-created */}
          <AdultEligibility characters={characters} computed={computed} effectiveAvg={effectiveAvg} />
        </div>
      );
    }

    // ---------- Subcomponents ----------
    function Summary({ characters, computed, effectiveAvg }) {
      const overall = (() => {
        const vals = characters.map(c => effectiveAvg(c, computed[c.id]) ?? 0);
        const count = characters.length; return count ? vals.reduce((a,b)=>a+b,0)/count : 0;
      })();

      return (
        <div className="grid grid-cols-1 gap-4 text-sm">
          <div className="space-y-2">
            <div>Total characters: <span className="font-medium">{characters.length}</span></div>
            <div className="space-y-1">
              {characters.map((c) => {
                const pc = computed[c.id];
                const label = c.name ? c.name : '(unnamed)';
                const avgVal = effectiveAvg(c, pc);
                const avgStr = avgVal != null ? formatAvg(avgVal) : '‚Äî';
                return (
                  <div key={c.id}>{label} average: <span className="font-medium">{avgStr}</span> <span className="text-slate-500">posts/term</span></div>
                );
              })}
            </div>
            <div>Overall average: <span className="font-medium">{formatAvg(overall)}</span> <span className="text-slate-500">posts/term</span></div>
          </div>
        </div>
      );
    }

    function Twins({ characters, computed, effectiveAvg }) {
      const allHavePosts = characters.every(c => c.currentPosts !== "");
      const items = characters.map(c => {
        const pc = computed[c.id];
        const avg = effectiveAvg(c, pc) ?? 0;
        const min = c.isSpirit ? 0 : (pc?.twoPlusYears ? 10 : 20);
        return { id: c.id, name: c.name || '(unnamed)', avg, min, shortfall: Math.max(0, min - avg) };
      });
      const overallAvg = (() => {
        const vals = items.map(i => i.avg); const n = items.length; return n ? vals.reduce((a,b)=>a+b,0)/n : 0;
      })();
      const overallOk = overallAvg >= 20;
      const below = items.filter(i => i.shortfall > 0);
      const perCharOk = below.length === 0;
      const eligible = allHavePosts && overallOk && perCharOk;

      return (
        <section className="mt-5 rounded-2xl border p-4 shadow-sm bg-white border-slate-200/60">
          <h2 className="text-lg font-semibold">Twins Eligibility</h2>
          <p className="text-sm text-slate-600 mb-2">
            Baseline is <span className="font-medium">20+ posts/term per character</span>. Characters that are <span className="font-medium">2+ RL years</span> old need <span className="font-medium">10+/term</span>. Spirit characters have no minimum. Group totals can compensate.
          </p>
          <div>
            <div className="flex items-center gap-2 mb-1">
              <span className="text-slate-600">Twins Eligible:</span>
              {!allHavePosts ? (<Badge pending>Pending</Badge>) : eligible ? (<Badge ok>Met</Badge>) : (<Badge ok={false}>Not met</Badge>)}
            </div>

            {allHavePosts && !eligible && (
              <div className="mt-2 rounded-lg bg-slate-50 border border-slate-200/60 p-3 text-sm">
                {!overallOk && (
                  <p className="mb-2">Your overall average is below 20 posts/term.
                    You need about <span className="font-semibold">{formatAvg(Math.max(0, 20 - overallAvg))}</span> more posts per character on average.</p>
                )}
                {below.length > 0 && (
                  <div>
                    <p className="mb-1">These characters are below their personal minimum (20/term; 10/term if 2+ RL yrs; spirits 0):</p>
                    <ul className="list-disc pl-5 space-y-1">
                      {below.map(i => (
                        <li key={i.id}><span className="font-medium">{i.name}</span> ‚Äî {formatAvg(i.avg)}/term; needs ~<span className="font-semibold">{formatAvg(i.shortfall)}</span> to reach <span className="font-semibold">{i.min}</span>/term.</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            )}
          </div>
        </section>
      );
    }

    function PlusEligibility({ characters, computed, effectiveAvg }) {
      const showPlusIsDynamic = characters.length >= 7;
      const plusLabel = `${Math.max(7, characters.length + (characters.length >= 7 ? 1 : 0))}+ Character Eligibility`;

      const allHavePosts = characters.every(c => c.currentPosts !== "");
      const items = characters.map(c => {
        const pc = computed[c.id];
        const avg = effectiveAvg(c, pc) ?? 0;
        const min = c.isSpirit ? 0 : (pc?.twoPlusYears ? 10 : 20);
        return { id: c.id, name: c.name || '(unnamed)', avg, min, shortfall: Math.max(0, min - avg) };
      });
      const totalRequired = items.reduce((s,i)=> s + i.min, 0);
      const totalActual = items.reduce((s,i)=> s + i.avg, 0);
      const overallMeets = totalActual >= totalRequired;
      const below = items.filter(i => i.shortfall > 0);
      const eligible = allHavePosts && overallMeets;

      return (
        <section className="mt-5 rounded-2xl border p-4 shadow-sm bg-white border-slate-200/60">
          <h2 className="text-lg font-semibold mb-2">{showPlusIsDynamic ? plusLabel : '7th+ Character Eligibility'}</h2>
          <p className="text-sm text-slate-600 mb-2">
            Baseline is <span className="font-medium">20+ posts/term per character</span>. Characters that are <span className="font-medium">2+ RL years</span> old need <span className="font-medium">10+/term</span>. Spirit characters have no minimum. Group totals can compensate.
          </p>
          <div>
            <div className="flex items-center gap-2 mb-1">
              <span className="text-slate-600">Eligible for {showPlusIsDynamic ? plusLabel.replace(' Character Eligibility','') : '7th+'} application:</span>
              {!allHavePosts ? (<Badge pending>Pending</Badge>) : eligible ? (<Badge ok>Met</Badge>) : (<Badge ok={false}>Not met</Badge>)}
            </div>
            <div className="text-sm text-slate-700 mb-2">Total avg across characters: <span className="font-medium">{formatAvg(totalActual)}</span> ¬∑ Required total: <span className="font-medium">{formatAvg(totalRequired)}</span></div>
            {allHavePosts && !eligible && (
              <div className="mt-2 rounded-lg bg-slate-50 border border-slate-200/60 p-3 text-sm">
                {!overallMeets && (<p className="mb-2">Your combined per-term average across all characters is below the required total. You need about <span className="font-semibold">{formatAvg(Math.max(0, totalRequired - totalActual))}</span> more posts/term overall.</p>)}
                {below.length > 0 && (
                  <div>
                    <p className="mb-1">These characters are below their personal minimum:</p>
                    <ul className="list-disc pl-5 space-y-1">{below.map(i => (<li key={i.id}><span className="font-medium">{i.name}</span> ‚Äî {formatAvg(i.avg)}/term; needs ~<span className="font-semibold">{formatAvg(i.shortfall)}</span> to reach <span className="font-semibold">{i.min}</span>/term.</li>))}</ul>
                  </div>
                )}
              </div>
            )}
          </div>
        </section>
      );
    }

    function AdultEligibility({ characters, computed, effectiveAvg }) {
      const allHavePosts = characters.every(c => c.currentPosts !== "");

      const items = characters.map(c => {
        const pc = computed[c.id];
        const avg = effectiveAvg(c, pc) ?? 0;
        return { id: c.id, name: c.name || '(unnamed)', avg, pc, isSpirit: c.isSpirit };
      });

      const anyAdultCreated = characters.some(c => c.isAdultCreated);
      const anyAdultCreatedOneYear = characters.some(c => c.isAdultCreated && (computed[c.id]?.onePlusYears));

      function checkBaseline(baseline) {
        const perCharMins = items.map(it => {
          const floor = it.isSpirit ? 0 : (it.pc?.twoPlusYears ? 10 : baseline);
          return { ...it, min: floor, shortfall: Math.max(0, floor - it.avg) };
        });
        const overallAvg = (() => { const n = perCharMins.length; return n ? perCharMins.reduce((s,i)=> s + i.avg, 0)/n : 0; })();
        const overallOk = overallAvg >= baseline;
        const below = perCharMins.filter(i => i.shortfall > 0);
        const perCharOk = below.length === 0;
        return { overallAvg, overallOk, perCharMins, below, perCharOk };
      }

      const first = checkBaseline(30);
      const second = checkBaseline(50);

      const firstEligible = allHavePosts && first.overallOk && first.perCharOk;
      const secondEligible = allHavePosts && second.overallOk && second.perCharOk && anyAdultCreated && anyAdultCreatedOneYear;

      return (
        <section className="mt-5 rounded-2xl border p-4 shadow-sm bg-white border-slate-200/60">
          <h2 className="text-lg font-semibold mb-1">Adult-Character Eligibility</h2>
          <p className="text-sm text-slate-600 mb-2">
            First/only adult-created (‚â• 30 avg/character) and (2) second adult-created (‚â• 50 avg/character and an existing adult-created ‚â• 1 RL year old).
            Characters 2+ RL years old use 10/term personal minimum; spirits 0.
          </p>

          <div className="space-y-4">
            <div>
              <div className="flex items-center gap-2 mb-1">
                <span className="text-slate-600">First/Only Adult-Created:</span>
                {!allHavePosts ? (<Badge pending>Pending</Badge>) : firstEligible ? (<Badge ok>Met</Badge>) : (<Badge ok={false}>Not met</Badge>)}
              </div>
              <div className="text-xs text-slate-600 mb-2">Overall average: <span className="font-medium">{formatAvg(first.overallAvg)}</span> (needs ‚â• 30)</div>
              {allHavePosts && !firstEligible && (
                <div className="rounded-lg bg-slate-50 border border-slate-200/60 p-3 text-sm">
                  {!first.overallOk && <p className="mb-2">Your overall average is below 30 posts/term. Add about <span className="font-semibold">{formatAvg(Math.max(0, 30 - first.overallAvg))}</span> more posts/term per character on average.</p>}
                  {first.below.length > 0 && (
                    <div>
                      <p className="mb-1">These characters are below their personal minimum (baseline 30; 10 if 2+ RL yrs; spirits 0):</p>
                      <ul className="list-disc pl-5 space-y-1">{first.below.map(i => (<li key={i.id}><span className="font-medium">{i.name}</span> ‚Äî {formatAvg(i.avg)}/term; needs ~<span className="font-semibold">{formatAvg(i.shortfall)}</span> to reach <span className="font-semibold">{i.min}</span>/term.</li>))}</ul>
                    </div>
                  )}
                </div>
              )}
            </div>

            <div>
              <div className="flex items-center gap-2 mb-1">
                <span className="text-slate-600">Second Adult-Created:</span>
                {!allHavePosts ? (<Badge pending>Pending</Badge>) : secondEligible ? (<Badge ok>Met</Badge>) : (<Badge ok={false}>Not met</Badge>)}
              </div>
              <div className="text-xs text-slate-600 mb-2">
                Overall average: <span className="font-medium">{formatAvg(second.overallAvg)}</span> (needs ‚â• 50)
                {anyAdultCreated ? (anyAdultCreatedOneYear ? ' ‚Ä¢ existing adult ‚â• 1y ‚úî' : ' ‚Ä¢ existing adult ‚â• 1y ‚úñ') : ' ‚Ä¢ no existing adult account'}
              </div>
              {allHavePosts && !secondEligible && (
                <div className="rounded-lg bg-slate-50 border border-slate-200/60 p-3 text-sm">
                  {(!anyAdultCreated || !anyAdultCreatedOneYear) && (
                    <p className="mb-2">Requirement: you must already have an adult-created character that is at least one real-life year old.</p>
                  )}
                  {!second.overallOk && <p className="mb-2">Your overall average is below 50 posts/term. Add about <span className="font-semibold">{formatAvg(Math.max(0, 50 - second.overallAvg))}</span> more posts/term per character on average.</p>}
                  {second.below.length > 0 && (
                    <div>
                      <p className="mb-1">These characters are below their personal minimum (baseline 50; 10 if 2+ RL yrs; spirits 0):</p>
                      <ul className="list-disc pl-5 space-y-1">{second.below.map(i => (<li key={i.id}><span className="font-medium">{i.name}</span> ‚Äî {formatAvg(i.avg)}/term; needs ~<span className="font-semibold">{formatAvg(i.shortfall)}</span> to reach <span className="font-semibold">{i.min}</span>/term.</li>))}</ul>
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        </section>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
