<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBCode Formatter - PW Tools</title>
    <link rel="icon" type="image/png" href="../assets/img/witch-hat.png">
    <style>
        /* ---------- Base reset ---------- */
        *{margin:0;padding:0;box-sizing:border-box}

        /* ---------- Base layout/typography ---------- */
        body{
          font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
          background:#f8fafc;
          color:#0f172a;
          line-height:1.6;
          transition:all .3s ease;
        }
        .container{max-width:1000px;margin:0 auto;padding:2rem 1.5rem;min-height:100vh}

        .header{margin-bottom:2rem;display:flex;flex-direction:column;gap:1rem;text-align:center}

        .title{
          font-size:2.5rem;font-weight:700;
          background:linear-gradient(135deg,#4f46e5,#7c3aed);
          -webkit-background-clip:text;background-clip:text;color:transparent;
          margin-bottom:.5rem;
        }
        .subtitle{color:#64748b;font-size:1.1rem;max-width:600px;margin:0 auto}

        /* ---------- Tokens ---------- */
        :root{
          --bg:#f8fafc;
          --ink:#0f172a;
          --panel:#ffffff;
          --border:rgba(226,232,240,.7);
          --muted:#64748b;
          --accent:#4f46e5;
        }

        /* ---------- Cards ---------- */
        .card{
          background:#fff;border:1px solid rgba(226,232,240,.7);border-radius:1rem;padding:2rem;
          box-shadow:0 1px 3px rgba(0,0,0,.1);transition:all .3s ease;
          margin-bottom:1.5rem;
        }
        .card:hover{box-shadow:0 10px 25px rgba(0,0,0,.1)}
        .card-desc{font-size:.95rem;color:#64748b;margin-bottom:2rem;text-align:center}

        /* ---------- Mode Toggle ---------- */
        .mode-toggle{
          display:flex;background:#f1f5f9;border-radius:12px;padding:6px;margin-bottom:2rem;
          width:fit-content;margin-left:auto;margin-right:auto;
        }
        .mode-btn{
          padding:0.75rem 1.5rem;border-radius:8px;border:none;background:transparent;
          cursor:pointer;transition:all 0.2s ease;font-weight:500;font-size:0.9rem;
        }
        .mode-btn.active{background:#fff;color:var(--accent);box-shadow:0 2px 4px rgba(0,0,0,0.1)}

        /* ---------- Visual Editor ---------- */
        .editor-container{margin-bottom:2rem}
        .editor-label{
          display:block;font-weight:500;color:var(--ink);margin-bottom:.75rem;font-size:.9rem;
        }

        .visual-editor{
          background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px 24px;
          font-family:inherit;font-size:1rem;transition:all .2s ease;width:100%;
          color:var(--ink);min-height:200px;line-height:1.6;
          outline:none;overflow-y:auto;
        }
        .visual-editor:focus{
          outline:2px solid rgba(79,70,229,.5);outline-offset:2px;border-color:var(--accent);
        }
        .visual-editor:empty:before{
          content:'Start typing here... Select text to format it!';
          color:#94a3b8;font-style:italic;
        }

        .visual-editor img{
          max-width:100%;height:auto;display:block;margin:10px 0;
          border:1px solid #e2e8f0;border-radius:8px;
        }

        .bbcode-input{
          background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px 24px;
          font-family:monospace;font-size:.9rem;transition:all .2s ease;width:100%;
          color:var(--ink);min-height:200px;resize:vertical;display:none;
        }
        .bbcode-input:focus{
          outline:2px solid rgba(79,70,229,.5);outline-offset:2px;border-color:var(--accent);
        }

        /* ---------- Selection Info ---------- */
        .selection-info{
          background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;
          padding:1rem;margin-bottom:2rem;font-size:0.85rem;color:#0369a1;
        }

        /* ---------- Toolbar ---------- */
        .toolbar{
          background:#f8fafc;border:1px solid var(--border);border-radius:12px;
          padding:1.5rem;margin-bottom:2rem;display:grid;gap:1rem;
        }

        .toolbar-row{
          display:flex;gap:1rem;align-items:center;flex-wrap:wrap;
        }

        .toolbar-group{
          display:flex;align-items:center;gap:0.75rem;
          padding:0.75rem 1rem;border-radius:8px;background:#fff;
          border:1px solid rgba(226,232,240,.5);
          min-height:60px;
        }

        .toolbar-group.full-width{
          width:100%;justify-content:space-between;
        }

        .toolbar-btn{
          background:#fff;border:1px solid var(--border);border-radius:6px;
          padding:0.6rem 1rem;cursor:pointer;transition:all 0.2s ease;
          font-weight:500;font-size:0.85rem;white-space:nowrap;
        }
        .toolbar-btn:hover{background:#f1f5f9;border-color:var(--accent)}
        .toolbar-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
        .toolbar-btn:disabled{opacity:0.5;cursor:not-allowed}

        .color-input{
          width:45px;height:40px;border:2px solid var(--border);border-radius:6px;
          cursor:pointer;transition:all 0.2s ease;
        }
        .color-input:hover{border-color:var(--accent)}

        .hex-input{
          border:1px solid var(--border);border-radius:6px;padding:0.6rem;
          background:#fff;font-size:0.8rem;width:90px;text-transform:uppercase;
        }

        .url-input{
          border:1px solid var(--border);border-radius:6px;padding:0.6rem;
          background:#fff;font-size:0.8rem;width:200px;
        }

        .size-select{
          border:1px solid var(--border);border-radius:6px;padding:0.6rem;
          background:#fff;cursor:pointer;font-size:0.85rem;min-width:100px;
        }

        .group-label{
          font-size:0.8rem;color:var(--muted);font-weight:500;margin-right:0.5rem;
          white-space:nowrap;
        }

        .color-controls{
          display:flex;align-items:center;gap:0.75rem;
        }

        /* ---------- BBCode Output ---------- */
        .bbcode-output-section{
          background:#fff;border:1px solid var(--border);border-radius:12px;
          padding:2rem;margin-top:1rem;
        }

        .bbcode-output{
          font-family:monospace;background:#f8fafc;border:1px solid #e2e8f0;
          border-radius:8px;padding:1.5rem;white-space:pre-wrap;word-wrap:break-word;
          font-size:0.9rem;line-height:1.5;min-height:120px;
        }

        .copy-btn{
          background:rgba(79,70,229,.1);border:1px solid rgba(79,70,229,.3);
          color:var(--accent);padding:0.75rem 1.5rem;border-radius:8px;
          font-size:0.9rem;cursor:pointer;margin-top:1.5rem;
          transition:all 0.2s ease;font-weight:500;
        }
        .copy-btn:hover{
          background:rgba(79,70,229,.2);transform:translateY(-1px);
        }

        /* ---------- Footer ---------- */
        .footer{
          font-size:.875rem;color:#94a3b8;border-top:1px solid rgba(226,232,240,.6);
          padding-top:2rem;margin-top:2rem;text-align:center;
        }

        /* ---------- Home Link ---------- */
        .home-link{
          background:#e2e8f0;border:none;padding:.75rem 1.25rem;border-radius:1.5rem;
          font-weight:500;cursor:pointer;transition:all .2s ease;
          display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:inherit;
          font-size:0.9rem;
        }
        .home-link:hover{background:#cbd5e1;transform:translateY(-1px)}
        .home-link .icon{font-size:1em;line-height:1;}
        .home-link:focus-visible{outline:2px solid rgba(79,70,229,.5);outline-offset:2px}

        @media (max-width:768px){
          .toolbar{padding:1rem;}
          .toolbar-row{flex-direction:column;align-items:stretch;}
          .toolbar-group{justify-content:center;min-height:auto;}
          .container{padding:1.5rem 1rem;}
          .url-input{width:150px;}
        }

        @media (min-width:768px){
          .header{flex-direction:row;align-items:center;justify-content:space-between;text-align:left}
          .subtitle{margin:0}
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div>
                <h1 class="title">BBCode Formatter</h1>
                <p class="subtitle">
                    Visual editor for beautiful Potter's World forum posts and signatures!
                </p>
            </div>
            <a href="../index.html" class="home-link">
                <span class="icon">üè†</span>
                Home
            </a>
        </header>
        
        <div class="card">
            <p class="card-desc">Type and format your text visually! Select any text to change its formatting, colors, or create gradients. Add images to create rich content.</p>
            
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode('visual')" id="visualModeBtn">‚ú® Visual Editor</button>
                <button class="mode-btn" onclick="setMode('bbcode')" id="bbcodeModeBtn">üíª BBCode Input</button>
            </div>

            <div class="editor-container">
                <label class="editor-label" id="editorLabel">Your Text</label>
                <div class="visual-editor" id="visualEditor" contenteditable="true" 
                    oninput="updateBBCodeOutput()" onmouseup="updateToolbarState()" onkeyup="updateToolbarState()" onkeydown="handleEnterKey(event)"></div>
                <textarea class="bbcode-input" id="bbcodeInput" 
                    placeholder="Paste your BBCode here..." oninput="updateVisualEditor()"></textarea>
            </div>

            <div class="selection-info" id="selectionInfo">
                üí° Tip: Select any text to format it, or click where you want to start typing with formatting
            </div>

            <div class="toolbar">
                <!-- Row 1: Basic Formatting -->
                <div class="toolbar-row">
                    <div class="toolbar-group">
                        <span class="group-label">Style:</span>
                        <button class="toolbar-btn" onclick="formatText('bold')" id="boldBtn"><strong>B</strong></button>
                        <button class="toolbar-btn" onclick="formatText('italic')" id="italicBtn"><em>I</em></button>
                        <button class="toolbar-btn" onclick="formatText('underline')" id="underlineBtn"><u>U</u></button>
                        <button class="toolbar-btn" onclick="formatText('strikeThrough')" id="strikeBtn"><s>S</s></button>
                    </div>

                    <div class="toolbar-group">
                        <span class="group-label">Size:</span>
                        <select id="fontSize" class="size-select" onchange="applyFontSize()">
                            <option value="">Default</option>
                            <option value="8">8px</option>
                            <option value="10">10px</option>
                            <option value="12">12px</option>
                            <option value="14">14px</option>
                            <option value="16">16px</option>
                            <option value="18">18px</option>
                            <option value="20">20px</option>
                            <option value="24">24px</option>
                            <option value="28">28px</option>
                            <option value="32">32px</option>
                        </select>
                    </div>

                    <div class="toolbar-group">
                        <span class="group-label">Align:</span>
                        <button class="toolbar-btn" onclick="formatText('justifyLeft')" id="leftBtn" title="Align Left">‚¨ÖÔ∏è</button>
                        <button class="toolbar-btn" onclick="formatText('justifyCenter')" id="centerBtn" title="Align Center">‚¨ÜÔ∏è</button>
                        <button class="toolbar-btn" onclick="formatText('justifyRight')" id="rightBtn" title="Align Right">‚û°Ô∏è</button>
                    </div>
                </div>

                <!-- Row 2: Colors -->
                <div class="toolbar-row">
                    <div class="toolbar-group full-width">
                        <div class="color-controls">
                            <span class="group-label">Text Color:</span>
                            <input type="color" id="colorPicker" class="color-input" value="#000000">
                            <input type="text" id="hexInput" class="hex-input" placeholder="#000000" maxlength="7">
                            <button class="toolbar-btn" onclick="applyTextColor()" title="Apply Color">üé® Apply</button>
                        </div>
                        
                        <div class="color-controls">
                            <span class="group-label">Gradient:</span>
                            <input type="color" id="gradientStart" class="color-input" value="#ff0000" title="Start Color">
                            <span style="font-size:0.8rem;color:var(--muted)">‚Üí</span>
                            <input type="color" id="gradientEnd" class="color-input" value="#0000ff" title="End Color">
                            <button class="toolbar-btn" onclick="applyGradient()" title="Apply Gradient">üåà Apply</button>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Image and Clear -->
                <div class="toolbar-row">
                    <div class="toolbar-group">
                        <span class="group-label">Image:</span>
                        <input type="text" id="imageUrl" class="url-input" placeholder="Enter image URL...">
                        <button class="toolbar-btn" onclick="insertImage()" title="Insert Image">üñºÔ∏è Insert</button>
                    </div>
                    
                    <div class="toolbar-group">
                        <span class="group-label">Clear:</span>
                        <button class="toolbar-btn" onclick="clearSelectedFormatting()" title="Remove formatting from selected text only">Clear Selected</button>
                        <button class="toolbar-btn" onclick="clearAllFormatting()" title="Remove all formatting from entire document">Clear All</button>
                    </div>
                </div>
            </div>

            <div class="bbcode-output-section">
                <h3 style="margin-bottom:1.5rem;font-size:1.1rem">BBCode Output</h3>
                <div class="bbcode-output" id="bbcodeOutput">BBCode will appear here...</div>
                <button class="copy-btn" onclick="copyBBCode()">üìã Copy BBCode</button>
            </div>
        </div>
        
        <footer class="footer">
            <p>Unofficial Potterworld utilities ‚Ä¢ Made by ‚ú® mel for the community</p>
        </footer>
    </div>

    <script>
        let currentMode = 'visual';
        let visualEditor = document.getElementById('visualEditor');
        let bbcodeInput = document.getElementById('bbcodeInput');
        
        function setMode(mode) {
            currentMode = mode;
            
            // Update button states
            document.getElementById('visualModeBtn').classList.toggle('active', mode === 'visual');
            document.getElementById('bbcodeModeBtn').classList.toggle('active', mode === 'bbcode');
            
            // Show/hide appropriate editor
            if (mode === 'visual') {
                visualEditor.style.display = 'block';
                bbcodeInput.style.display = 'none';
                document.getElementById('editorLabel').textContent = 'Visual Editor';
                document.getElementById('selectionInfo').style.display = 'block';
                updateBBCodeOutput();
            } else {
                visualEditor.style.display = 'none';
                bbcodeInput.style.display = 'block';
                document.getElementById('editorLabel').textContent = 'BBCode Input';
                document.getElementById('selectionInfo').style.display = 'block';
                // Convert visual content to BBCode for editing
                bbcodeInput.value = document.getElementById('bbcodeOutput').textContent;
                updateVisualEditor();
            }
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                
                // Create a proper line break
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    // Create a div with a br inside for proper spacing
                    const newLine = document.createElement('div');
                    const br = document.createElement('br');
                    newLine.appendChild(br);
                    
                    range.deleteContents();
                    range.insertNode(newLine);
                    
                    // Position cursor at the beginning of the new line
                    range.setStart(newLine, 0);
                    range.setEnd(newLine, 0);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
                
                updateBBCodeOutput();
            }
        }

        function formatText(command) {
            document.execCommand(command, false, null);
            updateBBCodeOutput();
            updateToolbarState();
            visualEditor.focus();
        }

        function applyTextColor() {
            const colorValue = document.getElementById('colorPicker').value;
            const hexValue = document.getElementById('hexInput').value;
            
            // Use hex input if it's valid, otherwise use color picker
            let color = colorValue;
            if (hexValue && /^#[0-9A-F]{6}$/i.test(hexValue)) {
                color = hexValue;
            }
            
            // Apply color using execCommand which works better for continuing formatting
            document.execCommand('foreColor', false, color);
            updateBBCodeOutput();
            visualEditor.focus();
        }

        function applyFontSize() {
            const size = document.getElementById('fontSize').value;
            if (size) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    if (!range.collapsed) {
                        const span = document.createElement('span');
                        span.style.fontSize = size + 'px';
                        try {
                            range.surroundContents(span);
                        } catch (e) {
                            const contents = range.extractContents();
                            span.appendChild(contents);
                            range.insertNode(span);
                        }
                        selection.removeAllRanges();
                        updateBBCodeOutput();
                    }
                }
            }
            visualEditor.focus();
        }

        function applyGradient() {
            const startColor = document.getElementById('gradientStart').value;
            const endColor = document.getElementById('gradientEnd').value;
            
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                if (!range.collapsed) {
                    // Check if selection spans multiple block elements
                    const contents = range.cloneContents();
                    const hasBlockElements = contents.querySelector('div, p, br') !== null;
                    
                    if (hasBlockElements) {
                        // Multi-line selection - apply gradient to each text node individually
                        const walker = document.createTreeWalker(
                            range.commonAncestorContainer,
                            NodeFilter.SHOW_TEXT,
                            {
                                acceptNode: function(node) {
                                    return range.intersectsNode(node) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_SKIP;
                                }
                            }
                        );
                        
                        const textNodes = [];
                        let node;
                        while (node = walker.nextNode()) {
                            // Check if this text node is actually selected
                            const nodeRange = document.createRange();
                            nodeRange.selectNode(node);
                            if (range.compareBoundaryPoints(Range.END_TO_START, nodeRange) <= 0 &&
                                range.compareBoundaryPoints(Range.START_TO_END, nodeRange) >= 0) {
                                textNodes.push(node);
                            }
                        }
                        
                        // Apply gradient to each text node
                        textNodes.forEach(textNode => {
                            if (textNode.textContent.trim()) {
                                const span = document.createElement('span');
                                span.style.background = `linear-gradient(90deg, ${startColor}, ${endColor})`;
                                span.style.webkitBackgroundClip = 'text';
                                span.style.backgroundClip = 'text';
                                span.style.color = 'transparent';
                                span.setAttribute('data-gradient', `${startColor},${endColor}`);
                                
                                textNode.parentNode.insertBefore(span, textNode);
                                span.appendChild(textNode);
                            }
                        });
                        
                    } else {
                        // Single line selection - use the original method
                        const span = document.createElement('span');
                        span.style.background = `linear-gradient(90deg, ${startColor}, ${endColor})`;
                        span.style.webkitBackgroundClip = 'text';
                        span.style.backgroundClip = 'text';
                        span.style.color = 'transparent';
                        span.setAttribute('data-gradient', `${startColor},${endColor}`);
                        
                        try {
                            range.surroundContents(span);
                        } catch (e) {
                            const contents = range.extractContents();
                            span.appendChild(contents);
                            range.insertNode(span);
                        }
                    }
                    
                    selection.removeAllRanges();
                    updateBBCodeOutput();
                } else {
                    alert('Please select some text first to apply a gradient.');
                }
            }
            visualEditor.focus();
        }

        function insertImage() {
            const url = document.getElementById('imageUrl').value.trim();
            if (!url) {
                alert('Please enter an image URL first.');
                return;
            }

            // Create image element
            const img = document.createElement('img');
            img.src = url;
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.display = 'block';
            img.style.margin = '10px 0';
            img.style.border = '1px solid #e2e8f0';
            img.style.borderRadius = '8px';
            
            img.onerror = function() {
                alert('Failed to load image. Please check the URL.');
                this.remove();
                updateBBCodeOutput();
            };

            img.onload = function() {
                updateBBCodeOutput();
            };

            // Insert at cursor position or at the end
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                
                // Create a wrapper div for the image
                const wrapper = document.createElement('div');
                wrapper.appendChild(img);
                
                range.deleteContents();
                range.insertNode(wrapper);
                
                // Create a new line after the image
                const newLine = document.createElement('div');
                newLine.innerHTML = '<br>';
                range.setStartAfter(wrapper);
                range.insertNode(newLine);
                
                // Position cursor in the new line
                range.setStart(newLine, 0);
                range.setEnd(newLine, 0);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                // If no selection, append to end
                const wrapper = document.createElement('div');
                wrapper.appendChild(img);
                visualEditor.appendChild(wrapper);
                
                const newLine = document.createElement('div');
                newLine.innerHTML = '<br>';
                visualEditor.appendChild(newLine);
            }

            // Clear the input
            document.getElementById('imageUrl').value = '';
            updateBBCodeOutput();
            visualEditor.focus();
        }

        function clearSelectedFormatting() {
            const selection = window.getSelection();
            if (!selection.rangeCount || selection.getRangeAt(0).collapsed) {
                alert('Please select some text first to remove formatting from it.');
                return;
            }

            // Simply use browser's removeFormat - works for most formatting
            document.execCommand('removeFormat');
            
            updateBBCodeOutput();
            visualEditor.focus();
        }

        function clearAllFormatting() {
            // Get the text content (automatically handles line breaks)
            const allText = visualEditor.innerText || visualEditor.textContent || '';
            
            // Replace everything with plain text
            if (allText.trim()) {
                visualEditor.innerHTML = allText.replace(/\n/g, '<br>');
            } else {
                visualEditor.innerHTML = '<br>';
            }
            
            updateBBCodeOutput();
            visualEditor.focus();
        }

        function updateToolbarState() {
            document.getElementById('boldBtn').classList.toggle('active', document.queryCommandState('bold'));
            document.getElementById('italicBtn').classList.toggle('active', document.queryCommandState('italic'));
            document.getElementById('underlineBtn').classList.toggle('active', document.queryCommandState('underline'));
            document.getElementById('strikeBtn').classList.toggle('active', document.queryCommandState('strikeThrough'));
            
            document.getElementById('leftBtn').classList.toggle('active', document.queryCommandState('justifyLeft'));
            document.getElementById('centerBtn').classList.toggle('active', document.queryCommandState('justifyCenter'));
            document.getElementById('rightBtn').classList.toggle('active', document.queryCommandState('justifyRight'));
        }

        function htmlToBBCode(html) {
            let bbcode = html;
            
            // Handle images first
            bbcode = bbcode.replace(/<img[^>]*src="([^"]*)"[^>]*>/gi, '[img]$1[/img]');
            
            // Handle gradients
            bbcode = bbcode.replace(/<span[^>]*data-gradient="([^"]*)"[^>]*>(.*?)<\/span>/gi, function(match, colors, text) {
                const [start, end] = colors.split(',');
                return `[gradient=${start},${end}]${text}[/gradient]`;
            });
            
            // Handle alignment
            bbcode = bbcode.replace(/<div style="text-align:\s*center[^"]*"[^>]*>(.*?)<\/div>/gi, '[center]$1[/center]');
            bbcode = bbcode.replace(/<div style="text-align:\s*left[^"]*"[^>]*>(.*?)<\/div>/gi, '[left]$1[/left]');
            bbcode = bbcode.replace(/<div style="text-align:\s*right[^"]*"[^>]*>(.*?)<\/div>/gi, '[right]$1[/right]');
            
            // Handle font colors
            bbcode = bbcode.replace(/<span style="color:\s*([^;"]+)[^"]*"[^>]*>(.*?)<\/span>/gi, '[color=$1]$2[/color]');
            bbcode = bbcode.replace(/<font color="([^"]*)"[^>]*>(.*?)<\/font>/gi, '[color=$1]$2[/color]');
            
            // Handle font sizes
            bbcode = bbcode.replace(/<span style="font-size:\s*(\d+)px[^"]*"[^>]*>(.*?)<\/span>/gi, '[size=$1]$2[/size]');
            
            // Basic formatting
            bbcode = bbcode.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '[b]$1[/b]');
            bbcode = bbcode.replace(/<b[^>]*>(.*?)<\/b>/gi, '[b]$1[/b]');
            bbcode = bbcode.replace(/<em[^>]*>(.*?)<\/em>/gi, '[i]$1[/i]');
            bbcode = bbcode.replace(/<i[^>]*>(.*?)<\/i>/gi, '[i]$1[/i]');
            bbcode = bbcode.replace(/<u[^>]*>(.*?)<\/u>/gi, '[u]$1[/u]');
            bbcode = bbcode.replace(/<s[^>]*>(.*?)<\/s>/gi, '[s]$1[/s]');
            bbcode = bbcode.replace(/<strike[^>]*>(.*?)<\/strike>/gi, '[s]$1[/s]');
            
            // Clean up remaining HTML
            bbcode = bbcode.replace(/<div[^>]*>/gi, '');
            bbcode = bbcode.replace(/<\/div>/gi, '\n');
            bbcode = bbcode.replace(/<br[^>]*>/gi, '\n');
            bbcode = bbcode.replace(/<[^>]*>/g, '');
            
            // Clean up extra whitespace but preserve intentional line breaks
            bbcode = bbcode.replace(/\n{3,}/g, '\n\n').trim();
            
            return bbcode;
        }

        function bbcodeToHtml(bbcode) {
            return bbcode
                .replace(/\[img\](.*?)\[\/img\]/gi, '<div><img src="$1" style="max-width:100%;height:auto;display:block;margin:10px 0;border:1px solid #e2e8f0;border-radius:8px;"></div>')
                .replace(/\[gradient=([^,]+),([^\]]+)\](.*?)\[\/gradient\]/gi, '<span style="background:linear-gradient(90deg,$1,$2);-webkit-background-clip:text;background-clip:text;color:transparent" data-gradient="$1,$2">$3</span>')
                .replace(/\[b\](.*?)\[\/b\]/gi, '<strong>$1</strong>')
                .replace(/\[i\](.*?)\[\/i\]/gi, '<em>$1</em>')
                .replace(/\[u\](.*?)\[\/u\]/gi, '<u>$1</u>')
                .replace(/\[s\](.*?)\[\/s\]/gi, '<s>$1</s>')
                .replace(/\[color=([^\]]*)\](.*?)\[\/color\]/gi, '<span style="color:$1">$2</span>')
                .replace(/\[size=([^\]]*)\](.*?)\[\/size\]/gi, '<span style="font-size:$1px">$2</span>')
                .replace(/\[center\](.*?)\[\/center\]/gi, '<div style="text-align:center">$1</div>')
                .replace(/\[left\](.*?)\[\/left\]/gi, '<div style="text-align:left">$1</div>')
                .replace(/\[right\](.*?)\[\/right\]/gi, '<div style="text-align:right">$1</div>')
                .replace(/\n/g, '<br>');
        }

        function updateBBCodeOutput() {
            const htmlContent = visualEditor.innerHTML;
            const bbcode = htmlToBBCode(htmlContent);
            document.getElementById('bbcodeOutput').textContent = bbcode || 'BBCode will appear here...';
        }

        function updateVisualEditor() {
            const bbcode = bbcodeInput.value;
            const htmlContent = bbcodeToHtml(bbcode);
            visualEditor.innerHTML = htmlContent;
            document.getElementById('bbcodeOutput').textContent = bbcode || 'BBCode will appear here...';
        }

        async function copyBBCode() {
            const bbcode = document.getElementById('bbcodeOutput').textContent;
            if (bbcode === 'BBCode will appear here...') return;

            try {
                await navigator.clipboard.writeText(bbcode);
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            } catch (err) {
                const textArea = document.createElement('textarea');
                textArea.value = bbcode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('BBCode copied to clipboard!');
            }
        }

        // Update hex input when color picker changes
        document.getElementById('colorPicker').addEventListener('input', function() {
            document.getElementById('hexInput').value = this.value.toUpperCase();
        });

        // Update color picker when hex input changes
        document.getElementById('hexInput').addEventListener('input', function() {
            let hex = this.value;
            if (!hex.startsWith('#')) hex = '#' + hex;
            if (/^#[0-9A-F]{6}$/i.test(hex)) {
                document.getElementById('colorPicker').value = hex.toLowerCase();
            }
        });

        // Allow Enter key in image URL input
        document.getElementById('imageUrl').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                insertImage();
            }
        });

        // Initialize
        visualEditor.focus();
        updateBBCodeOutput();
    </script>
</body>
</html>
