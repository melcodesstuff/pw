<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signature Formatter</title>
    <style>
        /* ---------- Base reset ---------- */
        *{margin:0;padding:0;box-sizing:border-box}

        /* ---------- Base layout/typography ---------- */
        body{
          font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
          background:#f8fafc;
          color:#0f172a;
          line-height:1.6;
          transition:all .3s ease;
        }

        .container{max-width:1000px;margin:0 auto;padding:2rem 1.5rem;min-height:100vh}

        .header{
          margin-bottom:2rem;
          display:flex;
          align-items:flex-start;
          justify-content:space-between;
          gap:2rem;
        }
        
        .header-buttons {
          display:flex;
          align-items:center;
          flex-shrink:0;
        }
        
        .header > div:first-child {
          flex: 1;
        }

        .title{
          font-size:2.5rem;font-weight:700;
          background:linear-gradient(135deg,#4f46e5,#7c3aed);
          -webkit-background-clip:text;background-clip:text;color:transparent;
          margin-bottom:.5rem;line-height:1.2;
        }
        .subtitle{
          color:#64748b;
          font-size:1.1rem;
          max-width:600px;
          line-height:1.4;
          margin:0;
        }

        /* ---------- Home Link ---------- */
        .home-link{
          background:#e2e8f0;border:none;padding:.75rem 1.25rem;border-radius:1.5rem;
          font-weight:500;cursor:pointer;transition:all .2s ease;
          display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:inherit;
          font-size:0.9rem;
          flex-shrink:0;
        }
        .home-link:hover{background:#cbd5e1;transform:translateY(-1px)}
        .home-link .icon{font-size:1em;line-height:1;}
        .home-link:focus-visible{outline:2px solid rgba(79,70,229,.5);outline-offset:2px}

        /* ---------- Ko-fi Button ---------- */
        .kofi-btn{
          background:var(--accent);border:none;padding:.75rem;border-radius:1.5rem;
          font-weight:500;cursor:pointer;transition:all .2s ease;
          display:inline-flex;align-items:center;justify-content:center;text-decoration:none;color:#fff;
          font-size:0.9rem;width:44px;height:44px;position:relative;
          flex-shrink:0;margin-right:0.75rem;
        }
        .kofi-btn:hover{background:#3730a3;transform:translateY(-1px);color:#fff}
        .kofi-btn:focus-visible{outline:2px solid rgba(79,70,229,.5);outline-offset:2px}
        
        .kofi-btn::after {
          content: "Buy me a coffee";
          position: absolute;
          bottom: -2.5rem;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 0.5rem 0.75rem;
          border-radius: 6px;
          font-size: 0.75rem;
          white-space: nowrap;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.2s ease;
          z-index: 1000;
        }
        
        .kofi-btn:hover::after {
          opacity: 1;
        }

        /* ---------- Tokens ---------- */
        :root{
          --bg:#f8fafc;
          --ink:#0f172a;
          --panel:#ffffff;
          --border:rgba(226,232,240,.7);
          --muted:#64748b;
          --accent:#4f46e5;
        }

        /* ---------- Cards ---------- */
        .card{
          background:#fff;border:1px solid rgba(226,232,240,.7);border-radius:1rem;padding:2rem;
          box-shadow:0 1px 3px rgba(0,0,0,.1);transition:all .3s ease;
          margin-bottom:1.5rem;
        }
        .card:hover{box-shadow:0 10px 25px rgba(0,0,0,.1)}
        .card-desc{font-size:.95rem;color:#64748b;margin-bottom:2rem;text-align:center}

        /* ---------- Mode Toggle ---------- */
        .mode-toggle{
          display:flex;background:#f1f5f9;border-radius:12px;padding:6px;margin-bottom:2rem;
          width:fit-content;margin-left:auto;margin-right:auto;
        }
        .mode-btn{
          padding:0.75rem 1.5rem;border-radius:8px;border:none;background:transparent;
          cursor:pointer;transition:all 0.2s ease;font-weight:500;font-size:0.9rem;
        }
        .mode-btn.active{background:#fff;color:var(--accent);box-shadow:0 2px 4px rgba(0,0,0,0.1)}

        /* ---------- Visual Editor ---------- */
        .editor-container{margin-bottom:2rem}
        .editor-label{
          display:block;font-weight:500;color:var(--ink);margin-bottom:.75rem;font-size:.9rem;
        }

        .visual-editor{
          background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px 24px;
          font-family:inherit;font-size:1rem;transition:all .2s ease;width:100%;
          color:var(--ink);min-height:200px;line-height:1.6;
          outline:none;overflow-y:auto;
        }
        .visual-editor:focus{
          outline:2px solid rgba(79,70,229,.5);outline-offset:2px;border-color:var(--accent);
        }
        .visual-editor:empty:before{
          content:'Start typing here... Select text to format it!';
          color:#94a3b8;font-style:italic;
        }

        .visual-editor img{
          max-width:100%;height:auto;display:block;margin:10px 0;
          border:1px solid #e2e8f0;border-radius:8px;
        }

        .bbcode-input{
          background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px 24px;
          font-family:monospace;font-size:.9rem;transition:all .2s ease;width:100%;
          color:var(--ink);min-height:200px;resize:vertical;display:none;
        }
        .bbcode-input:focus{
          outline:2px solid rgba(79,70,229,.5);outline-offset:2px;border-color:var(--accent);
        }

        /* ---------- Selection Info ---------- */
        .selection-info{
          background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;
          padding:1rem;margin-bottom:2rem;font-size:0.85rem;color:#0369a1;
        }

        /* ---------- Toolbar ---------- */
        .toolbar{
          background:#f8fafc;border:1px solid var(--border);border-radius:12px;
          padding:1rem;margin-bottom:2rem;display:grid;gap:0.75rem;
        }

        .toolbar-row{
          display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap;
        }

        .toolbar-group{
          display:flex;align-items:center;gap:0.5rem;
          padding:0.5rem 0.75rem;border-radius:6px;background:#fff;
          border:1px solid rgba(226,232,240,.5);
          min-height:48px;
        }

        .toolbar-group.full-width{
          width:100%;justify-content:space-between;
          overflow-x:auto;flex-wrap:wrap;
        }

        .toolbar-btn{
          background:#fff;border:1px solid var(--border);border-radius:6px;
          padding:0.6rem 1rem;cursor:pointer;transition:all 0.2s ease;
          font-weight:500;font-size:0.85rem;white-space:nowrap;
        }
        .toolbar-btn:hover{background:#f1f5f9;border-color:var(--accent)}
        .toolbar-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
        .toolbar-btn:disabled{opacity:0.5;cursor:not-allowed}

        .color-input{
          width:36px;height:36px;border:2px solid var(--border);border-radius:6px;
          cursor:pointer;transition:all 0.2s ease;
        }
        .color-input:hover{border-color:var(--accent)}

        .hex-input{
          border:1px solid var(--border);border-radius:6px;padding:0.6rem;
          background:#fff;font-size:0.8rem;width:75px;text-transform:uppercase;
          font-family:monospace;
        }

        .url-input{
          border:1px solid var(--border);border-radius:6px;padding:0.5rem;
          background:#fff;font-size:0.8rem;width:180px;
        }

        .size-select{
          border:1px solid var(--border);border-radius:6px;padding:0.5rem;
          background:#fff;cursor:pointer;font-size:0.8rem;min-width:90px;
        }

        .font-select{
          border:1px solid var(--border);border-radius:6px;padding:0.5rem;
          background:#fff;cursor:pointer;font-size:0.8rem;min-width:120px;
        }

        .symbol-search{
          border:1px solid var(--border);border-radius:6px;padding:0.5rem;
          background:#fff;font-size:0.8rem;width:120px;margin-right:0.5rem;
        }

        .symbol-select{
          border:1px solid var(--border);border-radius:6px;padding:0.5rem;
          background:#fff;cursor:pointer;font-size:0.8rem;min-width:140px;
          font-family: inherit;
        }

        .group-label{
          font-size:0.8rem;color:var(--muted);font-weight:500;margin-right:0.5rem;
          white-space:nowrap;
        }

        .color-controls{
          display:flex;align-items:center;gap:0.5rem;
          flex-wrap:wrap;min-width:0;
        }
        
        .recent-colors{
          display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.5rem;
        }
        
        .recent-color{
          display:flex;flex-direction:column;align-items:center;gap:0.25rem;
          cursor:pointer;transition:all 0.2s ease;
        }
        
        .recent-color:hover{
          transform:scale(1.1);
        }
        
        .recent-color-swatch{
          width:25px;height:25px;border:2px solid var(--border);border-radius:4px;
        }
        
        .recent-color-hex{
          font-size:0.65rem;color:var(--muted);font-family:monospace;
        }

        .swap-btn{
          background:#f8fafc;border:1px solid var(--border);border-radius:4px;
          padding:0.25rem;cursor:pointer;transition:all 0.2s ease;
          font-size:0.7rem;display:flex;align-items:center;justify-content:center;
          width:26px;height:26px;
        }
        .swap-btn:hover{background:#f1f5f9;border-color:var(--accent)}

        /* ---------- BBCode Output ---------- */
        .bbcode-output-section{
          background:#fff;border:1px solid var(--border);border-radius:12px;
          padding:2rem;margin-top:1rem;
        }

        .bbcode-output{
          font-family:monospace;background:#f8fafc;border:1px solid #e2e8f0;
          border-radius:8px;padding:1.5rem;white-space:pre-wrap;word-wrap:break-word;
          font-size:0.9rem;line-height:1.5;min-height:120px;
        }

        .copy-btn{
          background:rgba(79,70,229,.1);border:1px solid rgba(79,70,229,.3);
          color:var(--accent);padding:0.75rem 1.5rem;border-radius:8px;
          font-size:0.9rem;cursor:pointer;margin-top:1.5rem;
          transition:all 0.2s ease;font-weight:500;
        }
        .copy-btn:hover{
          background:rgba(79,70,229,.2);transform:translateY(-1px);
        }

        /* ---------- Color Status ---------- */
        .color-status{
          font-size:0.75rem;
          color:var(--muted);
          font-style:italic;
          margin-left:0.5rem;
        }

        /* ---------- Footer ---------- */
        .footer{
          font-size:.875rem;color:#94a3b8;border-top:1px solid rgba(226,232,240,.6);
          padding-top:2rem;margin-top:2rem;text-align:center;
        }

        /* ---------- Mobile Responsive ---------- */
        @media (max-width:768px){
          .header{
            flex-direction:column;
            align-items:flex-start;
            gap:1rem;
          }
          
          .title{
            font-size:2rem;
          }
          
          .header > div:last-child{
            align-self:flex-end;
            width:100%;
            display:flex;
            justify-content:flex-end;
          }
          
          .toolbar{padding:0.75rem;}
          .toolbar-row{flex-direction:column;align-items:stretch;}
          .toolbar-group{justify-content:center;min-height:auto;flex-wrap:wrap;gap:0.25rem;}
          .toolbar-group.full-width{flex-direction:column;align-items:stretch;}
          .color-controls{justify-content:center;flex-wrap:wrap;}
          .container{padding:1.5rem 1rem;}
          .url-input{width:140px;}
          .hex-input{width:55px;}
          .font-select{min-width:110px;}
          .symbol-select{min-width:130px;}
          .symbol-search{width:110px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div>
                <h1 class="title">Signature Formatter</h1>
                <p class="subtitle">
                    Visual editor for signatures with letter-by-letter gradients that work in BBCode!
                </p>
            </div>
            <div class="header-buttons">
                <a href="https://ko-fi.com/N4N81JRSGT" class="kofi-btn" target="_blank" rel="noopener">
                    ☕
                </a>
                <a href="../index.html" class="home-link">
                    <span class="icon">🏠</span>
                    Home
                </a>
            </div>
        </header>
        
        <div class="card">
            <p class="card-desc">Style text with formatting, colors, letter-by-letter gradients, fonts, and case options. Choose from 80+ searchable symbols and add aligned images. Generates clean BBCode instantly!</p>
            
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode('visual')" id="visualModeBtn">✨ Visual Editor</button>
                <button class="mode-btn" onclick="setMode('bbcode')" id="bbcodeModeBtn">💻 BBCode Input</button>
            </div>

            <div class="editor-container">
                <div class="visual-editor" id="visualEditor" contenteditable="true" 
                    oninput="updateBBCodeOutput()" onmouseup="updateToolbarState()" onkeyup="updateToolbarState()" onkeydown="handleEnterKey(event)"></div>
                <textarea class="bbcode-input" id="bbcodeInput" 
                    placeholder="Paste your BBCode here..." oninput="updateVisualEditor()"></textarea>
            </div>

            <div class="selection-info" id="selectionInfo">
                💡 Tip: Select any text to format it, or click where you want to start typing with formatting
            </div>

            <div class="toolbar">
                <!-- Row 1: Basic Formatting -->
                <div class="toolbar-row">
                    <div class="toolbar-group">
                        <span class="group-label">Style:</span>
                        <button class="toolbar-btn" onclick="formatText('bold')" id="boldBtn"><strong>B</strong></button>
                        <button class="toolbar-btn" onclick="formatText('italic')" id="italicBtn"><em>I</em></button>
                        <button class="toolbar-btn" onclick="formatText('underline')" id="underlineBtn"><u>U</u></button>
                        <button class="toolbar-btn" onclick="formatText('strikeThrough')" id="strikeBtn"><s>S</s></button>
                        <button class="toolbar-btn" onclick="applySubscript()" id="subBtn">X<sub>₂</sub></button>
                        <button class="toolbar-btn" onclick="applySuperscript()" id="supBtn">X<sup>²</sup></button>
                    </div>

                    <div class="toolbar-group">
                        <span class="group-label">Case:</span>
                        <button class="toolbar-btn" onclick="transformCase('uppercase')" title="UPPERCASE">AA</button>
                        <button class="toolbar-btn" onclick="transformCase('lowercase')" title="lowercase">aa</button>
                        <button class="toolbar-btn" onclick="transformCase('propercase')" title="Proper Case">Aa</button>
                    </div>

                    <div class="toolbar-group">
                        <span class="group-label">Size:</span>
                        <select id="fontSize" class="size-select" onchange="applyFontSize()">
                            <option value="">Default</option>
                            <option value="8">8px</option>
                            <option value="10">10px</option>
                            <option value="12">12px</option>
                            <option value="14">14px</option>
                            <option value="16">16px</option>
                            <option value="18">18px</option>
                            <option value="20">20px</option>
                            <option value="24">24px</option>
                            <option value="28">28px</option>
                            <option value="32">32px</option>
                        </select>
                    </div>

                    <div class="toolbar-group">
                        <span class="group-label">Font:</span>
                        <select id="fontFamily" class="font-select" onchange="applyFontFamily()">
                            <option value="">Default</option>
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="Verdana, sans-serif">Verdana</option>
                            <option value="Tahoma, sans-serif">Tahoma</option>
                            <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                            <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="Monaco, monospace">Monaco</option>
                            <option value="'Lucida Console', monospace">Lucida Console</option>
                            <option value="Impact, sans-serif">Impact</option>
                            <option value="'Book Antiqua', serif">Book Antiqua</option>
                        </select>
                    </div>
                </div>

                <!-- Row 2: Colors -->
                <div class="toolbar-row">
                    <div class="toolbar-group full-width">
                        <div class="color-controls">
                            <span class="group-label">Text Color:</span>
                            <input type="text" id="hexInput" class="hex-input" placeholder="#000000" maxlength="7" oninput="updateColorFromHex()">
                            <input type="color" id="colorPicker" class="color-input" value="#000000" onchange="updateHexFromColor()">
                            <button class="toolbar-btn" onclick="applyTextColor()" title="Apply Color">🎨 Apply</button>
                        </div>
                        
                        <div class="color-controls">
                            <span class="group-label">Gradient:</span>
                            <input type="text" id="gradientStartHex" class="hex-input" placeholder="#ff0000" maxlength="7" oninput="updateGradientStartFromHex()">
                            <input type="color" id="gradientStart" class="color-input" value="#ff0000" onchange="updateGradientStartHex()" title="Start Color">
                            <button class="swap-btn" onclick="swapGradientColors()" title="Swap gradient colors">⇄</button>
                            <input type="text" id="gradientEndHex" class="hex-input" placeholder="#0000ff" maxlength="7" oninput="updateGradientEndFromHex()">
                            <input type="color" id="gradientEnd" class="color-input" value="#0000ff" onchange="updateGradientEndHex()" title="End Color">
                            <button class="toolbar-btn" onclick="applyGradient()" title="Apply Letter-by-Letter Gradient">🌈 Apply</button>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Symbols and Alignment -->
                <div class="toolbar-row">
                    <div class="toolbar-group">
                        <span class="group-label">Symbols:</span>
                        <input type="text" id="symbolSearch" class="symbol-search" placeholder="Search symbols..." oninput="filterSymbols()">
                        <select id="symbolPicker" class="symbol-select" onchange="insertSymbol()">
                            <option value="">Choose Symbol...</option>
                            <optgroup label="♥ Hearts & Love">
                                <option value="♥" data-keywords="heart love">♥ Heart</option>
                                <option value="♡" data-keywords="heart love outline">♡ Heart Outline</option>
                            </optgroup>
                            <optgroup label="★ Stars & Celestial">
                                <option value="★" data-keywords="star">★ Star</option>
                                <option value="☆" data-keywords="star outline">☆ Star Outline</option>
                                <option value="✦" data-keywords="star four point">✦ Four Point Star</option>
                                <option value="✧" data-keywords="star four point outline">✧ Four Point Star Outline</option>
                                <option value="☽" data-keywords="moon crescent">☽ Moon</option>
                                <option value="☾" data-keywords="moon crescent">☾ Moon</option>
                                <option value="☀" data-keywords="sun">☀ Sun</option>
                                <option value="✴" data-keywords="star eight point">✴ Eight Point Star</option>
                                <option value="❋" data-keywords="star asterisk">❋ Heavy Asterisk</option>
                                <option value="✱" data-keywords="star asterisk">✱ Heavy Asterisk</option>
                            </optgroup>
                            <optgroup label="→ Arrows & Directions">
                                <option value="→" data-keywords="arrow right">→ Right Arrow</option>
                                <option value="←" data-keywords="arrow left">← Left Arrow</option>
                                <option value="↑" data-keywords="arrow up">↑ Up Arrow</option>
                                <option value="↓" data-keywords="arrow down">↓ Down Arrow</option>
                                <option value="↔" data-keywords="arrow left right horizontal">↔ Left Right Arrow</option>
                                <option value="↕" data-keywords="arrow up down vertical">↕ Up Down Arrow</option>
                                <option value="➤" data-keywords="arrow triangle right">➤ Triangle Right</option>
                                <option value="➜" data-keywords="arrow heavy right">➜ Heavy Right</option>
                                <option value="⇒" data-keywords="arrow double right">⇒ Double Right</option>
                                <option value="⇐" data-keywords="arrow double left">⇐ Double Left</option>
                                <option value="⇑" data-keywords="arrow double up">⇑ Double Up</option>
                                <option value="⇓" data-keywords="arrow double down">⇓ Double Down</option>
                                <option value="↗" data-keywords="arrow diagonal up right">↗ Up Right Arrow</option>
                                <option value="↖" data-keywords="arrow diagonal up left">↖ Up Left Arrow</option>
                                <option value="↘" data-keywords="arrow diagonal down right">↘ Down Right Arrow</option>
                                <option value="↙" data-keywords="arrow diagonal down left">↙ Down Left Arrow</option>
                            </optgroup>
                            <optgroup label="♪ Music & Audio">
                                <option value="♪" data-keywords="music note eighth">♪ Eighth Note</option>
                                <option value="♫" data-keywords="music note beamed">♫ Beamed Notes</option>
                                <option value="♬" data-keywords="music note beamed">♬ Beamed Notes 2</option>
                                <option value="♭" data-keywords="music flat">♭ Flat</option>
                                <option value="♯" data-keywords="music sharp">♯ Sharp</option>
                                <option value="♮" data-keywords="music natural">♮ Natural</option>
                            </optgroup>
                            <optgroup label="◆ Shapes & Geometry">
                                <option value="●" data-keywords="circle black filled">● Circle</option>
                                <option value="○" data-keywords="circle white outline">○ Circle Outline</option>
                                <option value="■" data-keywords="square black filled">■ Square</option>
                                <option value="□" data-keywords="square white outline">□ Square Outline</option>
                                <option value="▲" data-keywords="triangle up black">▲ Triangle Up</option>
                                <option value="△" data-keywords="triangle up white outline">△ Triangle Up Outline</option>
                                <option value="▼" data-keywords="triangle down black">▼ Triangle Down</option>
                                <option value="▽" data-keywords="triangle down white outline">▽ Triangle Down Outline</option>
                                <option value="◆" data-keywords="diamond black filled">◆ Diamond</option>
                                <option value="◇" data-keywords="diamond white outline">◇ Diamond Outline</option>
                                <option value="♠" data-keywords="spade card suit">♠ Spade</option>
                                <option value="♣" data-keywords="club card suit">♣ Club</option>
                                <option value="♦" data-keywords="diamond card suit">♦ Diamond Suit</option>
                                <option value="♧" data-keywords="club card suit outline">♧ Club Outline</option>
                                <option value="◉" data-keywords="circle dot">◉ Circle with Dot</option>
                                <option value="◎" data-keywords="circle bullseye">◎ Bullseye</option>
                                <option value="▪" data-keywords="square small black">▪ Small Square</option>
                                <option value="▫" data-keywords="square small white">▫ Small White Square</option>
                            </optgroup>
                            <optgroup label="✓ Checks & Marks">
                                <option value="✓" data-keywords="check mark tick">✓ Check Mark</option>
                                <option value="✔" data-keywords="check mark heavy tick">✔ Heavy Check</option>
                                <option value="✗" data-keywords="x mark cross">✗ X Mark</option>
                                <option value="✘" data-keywords="x mark heavy cross">✘ Heavy X</option>
                                <option value="⚠" data-keywords="warning caution">⚠ Warning</option>
                                <option value="⚡" data-keywords="lightning bolt">⚡ Lightning</option>
                                <option value="☢" data-keywords="radioactive">☢ Radioactive</option>
                                <option value="☣" data-keywords="biohazard">☣ Biohazard</option>
                                <option value="⚜" data-keywords="fleur de lis">⚜ Fleur-de-lis</option>
                            </optgroup>
                            <optgroup label="☀ Weather & Nature">
                                <option value="☀" data-keywords="sun sunny">☀ Sunny</option>
                                <option value="☁" data-keywords="cloud cloudy">☁ Cloud</option>
                                <option value="⛅" data-keywords="cloud partly cloudy">⛅ Partly Cloudy</option>
                                <option value="❄" data-keywords="snowflake snow">❄ Snowflake</option>
                                <option value="❅" data-keywords="snowflake snow">❅ Snowflake</option>
                                <option value="☂" data-keywords="umbrella rain">☂ Umbrella</option>
                                <option value="☘" data-keywords="clover shamrock">☘ Shamrock</option>
                                <option value="❀" data-keywords="flower">❀ Flower</option>
                                <option value="✿" data-keywords="flower">✿ Flower</option>
                                <option value="❁" data-keywords="flower">❁ Flower</option>
                                <option value="✾" data-keywords="flower">✾ Flower</option>
                            </optgroup>
                            <optgroup label="✦ Math & Science">
                                <option value="±" data-keywords="plus minus">± Plus Minus</option>
                                <option value="×" data-keywords="multiply times">× Multiply</option>
                                <option value="÷" data-keywords="divide division">÷ Divide</option>
                                <option value="≈" data-keywords="approximately equal">≈ Approximately</option>
                                <option value="≠" data-keywords="not equal">≠ Not Equal</option>
                                <option value="≤" data-keywords="less than equal">≤ Less Equal</option>
                                <option value="≥" data-keywords="greater than equal">≥ Greater Equal</option>
                                <option value="∞" data-keywords="infinity">∞ Infinity</option>
                                <option value="π" data-keywords="pi">π Pi</option>
                                <option value="∑" data-keywords="sum sigma">∑ Sum</option>
                                <option value="∆" data-keywords="delta change">∆ Delta</option>
                                <option value="∇" data-keywords="nabla gradient">∇ Nabla</option>
                                <option value="∈" data-keywords="element of">∈ Element Of</option>
                                <option value="∉" data-keywords="not element of">∉ Not Element Of</option>
                                <option value="∀" data-keywords="for all">∀ For All</option>
                                <option value="∃" data-keywords="there exists">∃ There Exists</option>
                            </optgroup>
                            <optgroup label="© Special Characters">
                                <option value="©" data-keywords="copyright">© Copyright</option>
                                <option value="®" data-keywords="registered trademark">® Registered</option>
                                <option value="™" data-keywords="trademark">™ Trademark</option>
                                <option value="°" data-keywords="degree">° Degree</option>
                                <option value="§" data-keywords="section">§ Section</option>
                                <option value="¶" data-keywords="paragraph">¶ Paragraph</option>
                                <option value="†" data-keywords="dagger cross">† Dagger</option>
                                <option value="‡" data-keywords="double dagger cross">‡ Double Dagger</option>
                                <option value="•" data-keywords="bullet point">• Bullet</option>
                                <option value="‣" data-keywords="triangle bullet point">‣ Triangle Bullet</option>
                                <option value="…" data-keywords="ellipsis dots">… Ellipsis</option>
                                <option value="–" data-keywords="en dash">– En Dash</option>
                                <option value="—" data-keywords="em dash">— Em Dash</option>
                                <option value="‹" data-keywords="quote angle bracket">‹ Single Left Quote</option>
                                <option value="›" data-keywords="quote angle bracket">› Single Right Quote</option>
                                <option value="«" data-keywords="quote angle bracket">« Double Left Quote</option>
                                <option value="»" data-keywords="quote angle bracket">» Double Right Quote</option>
                                <option value="‰" data-keywords="percent per mille">‰ Per Mille</option>
                                <option value="‱" data-keywords="percent basis point">‱ Basis Point</option>
                            </optgroup>
                            <optgroup label="☺ Faces & Gestures">
                                <option value="☺" data-keywords="smile happy face">☺ Smiling Face</option>
                                <option value="☻" data-keywords="smile happy face black">☻ Black Smiling</option>
                                <option value="☹" data-keywords="sad frown face">☹ Frowning Face</option>
                                <option value="✌" data-keywords="peace victory hand">✌ Peace</option>
                                <option value="☝" data-keywords="finger pointing up">☝ Index Pointing Up</option>
                                <option value="✋" data-keywords="hand raised stop">✋ Raised Hand</option>
                                <option value="✊" data-keywords="fist raised">✊ Raised Fist</option>
                                <option value="✍" data-keywords="writing hand">✍ Writing Hand</option>
                            </optgroup>
                            <optgroup label="⚔ Symbols & Misc">
                                <option value="⚔" data-keywords="sword crossed swords">⚔ Crossed Swords</option>
                                <option value="⚖" data-keywords="scale balance justice">⚖ Balance Scale</option>
                                <option value="⚗" data-keywords="alembic chemistry">⚗ Alembic</option>
                                <option value="⚙" data-keywords="gear settings">⚙ Gear</option>
                                <option value="⚓" data-keywords="anchor">⚓ Anchor</option>
                                <option value="⚡" data-keywords="lightning bolt">⚡ Lightning Bolt</option>
                                <option value="♨" data-keywords="hot springs steam">♨ Hot Springs</option>
                                <option value="☮" data-keywords="peace symbol">☮ Peace Symbol</option>
                                <option value="☯" data-keywords="yin yang">☯ Yin Yang</option>
                                <option value="☪" data-keywords="crescent star islam">☪ Star and Crescent</option>
                                <option value="✡" data-keywords="star david judaism">✡ Star of David</option>
                                <option value="☬" data-keywords="adi shakti">☬ Adi Shakti</option>
                                <option value="☭" data-keywords="hammer sickle">☭ Hammer and Sickle</option>
                                <option value="♻" data-keywords="recycle">♻ Recycling Symbol</option>
                                <option value="⚰" data-keywords="coffin">⚰ Coffin</option>
                                <option value="⚱" data-keywords="urn funeral">⚱ Funeral Urn</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="toolbar-group">
                        <span class="group-label">Align:</span>
                        <button class="toolbar-btn" onclick="formatText('justifyLeft')" id="leftBtn" title="Align Left">⬅️</button>
                        <button class="toolbar-btn" onclick="formatText('justifyCenter')" id="centerBtn" title="Align Center">⬆️</button>
                        <button class="toolbar-btn" onclick="formatText('justifyRight')" id="rightBtn" title="Align Right">➡️</button>
                    </div>
                </div>

                <!-- Row 4: Recent Colors -->
                <div class="toolbar-row">
                    <div class="toolbar-group full-width">
                        <div style="display:flex;flex-direction:column;gap:0.5rem;width:100%;">
                            <div style="display:flex;align-items:center;gap:0.5rem;">
                                <span class="group-label">Recent Colors:</span>
                                <span style="font-size:0.75rem;color:var(--muted);font-style:italic;">Click to reuse as text color</span>
                            </div>
                            <div class="recent-colors" id="recentColors">
                                <!-- Recent colors will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 5: Image Colors -->
                <div class="toolbar-row" id="imageColorsRow" style="display:none;">
                    <div class="toolbar-group full-width">
                        <div style="display:flex;flex-direction:column;gap:0.5rem;width:100%;">
                            <div style="display:flex;align-items:center;gap:0.5rem;">
                                <span class="group-label">Colors from Image:</span>
                                <span style="font-size:0.75rem;color:var(--muted);font-style:italic;">Click to use color from your image</span>
                                <span class="color-status" id="colorStatus"></span>
                            </div>
                            <div class="recent-colors" id="imageColors">
                                <!-- Image colors will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 6: Image and Clear -->
                <div class="toolbar-row">
                    <div class="toolbar-group">
                        <span class="group-label">Image:</span>
                        <input type="text" id="imageUrl" class="url-input" placeholder="Enter image URL...">
                        <button class="toolbar-btn" onclick="insertImage()" title="Insert Image">🖼️ Insert</button>
                        <button class="toolbar-btn" onclick="insertPlaceholderImage()" title="Insert Placeholder Image">📷 Placeholder</button>
                    </div>
                    
                    <div class="toolbar-group">
                        <span class="group-label">Clear:</span>
                        <button class="toolbar-btn" onclick="clearSelectedFormatting()" title="Remove formatting from selected text only">Clear Selected</button>
                        <button class="toolbar-btn" onclick="clearAllFormatting()" title="Remove all formatting from entire document">Clear All</button>
                    </div>
                </div>
            </div>

            <div class="bbcode-output-section">
                <h3 style="margin-bottom:1.5rem;font-size:1.1rem">BBCode Output</h3>
                <div class="bbcode-output" id="bbcodeOutput">BBCode will appear here...</div>
                <button class="copy-btn" onclick="copyBBCode()">📋 Copy BBCode</button>
            </div>
        </div>
        
        <footer class="footer">
            <p>Unofficial Potterworld utilities • Made by ✨ mel for the community</p>
        </footer>
    </div>

    <script>
        // Variables
        var currentMode = 'visual';
        var visualEditor = document.getElementById('visualEditor');
        var bbcodeInput = document.getElementById('bbcodeInput');
        var recentColors = [];

        // Mode switching
        function setMode(mode) {
            currentMode = mode;
            
            document.getElementById('visualModeBtn').classList.toggle('active', mode === 'visual');
            document.getElementById('bbcodeModeBtn').classList.toggle('active', mode === 'bbcode');
            
            if (mode === 'visual') {
                visualEditor.style.display = 'block';
                bbcodeInput.style.display = 'none';
                document.getElementById('selectionInfo').style.display = 'block';
                updateBBCodeOutput();
            } else {
                visualEditor.style.display = 'none';
                bbcodeInput.style.display = 'block';
                document.getElementById('selectionInfo').style.display = 'block';
                bbcodeInput.value = document.getElementById('bbcodeOutput').textContent;
                updateVisualEditor();
            }
        }

        // Basic formatting
        function formatText(command) {
            document.execCommand(command, false, null);
            updateBBCodeOutput();
            updateToolbarState();
            visualEditor.focus();
        }

        function applyTextColor() {
            var hexValue = document.getElementById('hexInput').value;
            var colorValue = document.getElementById('colorPicker').value;
            
            var color = colorValue;
            if (hexValue && /^#[0-9A-F]{6}$/i.test(hexValue)) {
                color = hexValue;
            }
            
            addToRecentColors(color);
            document.execCommand('foreColor', false, color);
            updateBBCodeOutput();
            visualEditor.focus();
        }

        function applyGradient() {
            var startColor = document.getElementById('gradientStart').value;
            var endColor = document.getElementById('gradientEnd').value;
            var selection = window.getSelection();
            
            if (!selection.rangeCount || selection.getRangeAt(0).collapsed) {
                alert('Please select some text first to apply a gradient.');
                return;
            }
            
            var range = selection.getRangeAt(0);
            var selectedText = range.toString();
            
            if (!selectedText.trim()) {
                alert('Please select some text first to apply a gradient.');
                return;
            }
            
            addToRecentColors(startColor);
            addToRecentColors(endColor);
            
            var letters = selectedText.replace(/\s/g, '');
            var fragment = document.createDocumentFragment();
            
            for (var i = 0; i < selectedText.length; i++) {
                var char = selectedText[i];
                var span = document.createElement('span');
                span.textContent = char;
                
                if (char.trim()) {
                    var factor = letters.length > 1 ? (selectedText.substring(0, i).replace(/\s/g, '').length) / (letters.length - 1) : 0;
                    var color = interpolateColor(startColor, endColor, factor);
                    span.style.color = color;
                    span.setAttribute('data-gradient-letter', color);
                }
                
                fragment.appendChild(span);
            }
            
            range.deleteContents();
            range.insertNode(fragment);
            
            updateBBCodeOutput();
            visualEditor.focus();
        }

        function interpolateColor(color1, color2, factor) {
            var hex1 = color1.replace('#', '');
            var hex2 = color2.replace('#', '');
            
            var r1 = parseInt(hex1.substring(0, 2), 16);
            var g1 = parseInt(hex1.substring(2, 4), 16);
            var b1 = parseInt(hex1.substring(4, 6), 16);
            
            var r2 = parseInt(hex2.substring(0, 2), 16);
            var g2 = parseInt(hex2.substring(2, 4), 16);
            var b2 = parseInt(hex2.substring(4, 6), 16);
            
            var r = Math.round(r1 + (r2 - r1) * factor);
            var g = Math.round(g1 + (g2 - g1) * factor);
            var b = Math.round(b1 + (b2 - b1) * factor);
            
            var rHex = r.toString(16);
            if (rHex.length === 1) rHex = '0' + rHex;
            var gHex = g.toString(16);
            if (gHex.length === 1) gHex = '0' + gHex;
            var bHex = b.toString(16);
            if (bHex.length === 1) bHex = '0' + bHex;
            
            return '#' + rHex + gHex + bHex;
        }

        // Image handling
        function insertImage() {
            var url = document.getElementById('imageUrl').value.trim();
            if (!url) {
                alert('Please enter an image URL first.');
                return;
            }

            var img = document.createElement('img');
            img.src = url;
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.display = 'block';
            img.style.margin = '10px auto 10px 0';
            img.style.border = '1px solid #e2e8f0';
            img.style.borderRadius = '8px';
            
            img.onload = function() {
                updateBBCodeOutput();
                extractImageColors(this);
            };
            
            img.onerror = function() {
                alert('Failed to load image. Please check the URL.');
                this.remove();
                updateBBCodeOutput();
            };

            visualEditor.focus();
            var selection = window.getSelection();
            var range;
            
            if (selection.rangeCount > 0) {
                range = selection.getRangeAt(0);
            } else {
                range = document.createRange();
                range.selectNodeContents(visualEditor);
                range.collapse(false);
            }
            
            range.deleteContents();
            range.insertNode(img);
            
            var newLine = document.createElement('div');
            newLine.innerHTML = '<br>';
            range.setStartAfter(img);
            range.insertNode(newLine);
            
            range.setStart(newLine, 0);
            range.setEnd(newLine, 0);
            selection.removeAllRanges();
            selection.addRange(range);

            document.getElementById('imageUrl').value = '';
            updateBBCodeOutput();
            visualEditor.focus();
        }

        function insertPlaceholderImage() {
            var img = document.createElement('img');
            img.src = 'https://placehold.co/500x200';
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.display = 'block';
            img.style.margin = '10px auto 10px 0';
            img.style.border = '1px solid #e2e8f0';
            img.style.borderRadius = '8px';
            
            img.onload = function() {
                updateBBCodeOutput();
                extractImageColors(this);
            };
            
            img.onerror = function() {
                alert('Failed to load placeholder image.');
                this.remove();
                updateBBCodeOutput();
            };

            visualEditor.appendChild(img);
            updateBBCodeOutput();
            visualEditor.focus();
        }

        function extractImageColors(img) {
            console.log('Analyzing image colors:', img.src);
            setColorStatus('Analyzing colors...');
            
            try {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                
                if (img.naturalWidth && img.naturalHeight) {
                    canvas.width = 50;
                    canvas.height = 50;
                    ctx.drawImage(img, 0, 0, 50, 50);
                    
                    var imageData = ctx.getImageData(0, 0, 50, 50);
                    var colors = extractColorsFromImageData(imageData);
                    
                    if (colors && colors.length > 0) {
                        displayImageColors(colors);
                        setColorStatus('✓ Colors extracted from image');
                        return;
                    }
                }
            } catch (e) {
                console.log('Direct extraction blocked:', e.message);
            }
            
            console.log('Using smart color analysis for:', img.src);
            setColorStatus('✓ Smart colors applied');
            displayImageColors(getThemeColors(img.src));
        }

        function extractColorsFromImageData(imageData) {
            var data = imageData.data;
            var colorMap = {};
            
            for (var i = 0; i < data.length; i += 16) {
                var r = data[i];
                var g = data[i + 1];
                var b = data[i + 2];
                var a = data[i + 3];
                
                if (a < 128) continue;
                
                var brightness = (r + g + b) / 3;
                if (brightness < 30 || brightness > 220) continue;
                
                var rHex = r.toString(16);
                if (rHex.length === 1) rHex = '0' + rHex;
                var gHex = g.toString(16);
                if (gHex.length === 1) gHex = '0' + gHex;
                var bHex = b.toString(16);
                if (bHex.length === 1) bHex = '0' + bHex;
                
                var hex = '#' + rHex + gHex + bHex;
                hex = hex.toUpperCase();
                
                if (colorMap[hex]) {
                    colorMap[hex]++;
                } else {
                    colorMap[hex] = 1;
                }
            }
            
            var colors = [];
            for (var color in colorMap) {
                colors.push({color: color, count: colorMap[color]});
            }
            
            colors.sort(function(a, b) {
                return b.count - a.count;
            });
            
            var result = [];
            for (var i = 0; i < Math.min(8, colors.length); i++) {
                result.push(colors[i].color);
            }
            
            return result;
        }

        function getThemeColors(url) {
            var urlLower = url.toLowerCase();
            
            if (urlLower.indexOf('sunset') !== -1 || urlLower.indexOf('orange') !== -1) {
                return ['#FF6B35', '#F7931E', '#FFD23F', '#FF8C42', '#C73E1D', '#FFA500', '#FF7F50', '#FFB347'];
            } else if (urlLower.indexOf('ocean') !== -1 || urlLower.indexOf('blue') !== -1 || urlLower.indexOf('water') !== -1) {
                return ['#006BA6', '#0496FF', '#87CEEB', '#4682B4', '#1E90FF', '#00CED1', '#20B2AA', '#48CAE4'];
            } else if (urlLower.indexOf('forest') !== -1 || urlLower.indexOf('green') !== -1 || urlLower.indexOf('nature') !== -1) {
                return ['#2D5016', '#61A63F', '#8FBC8F', '#228B22', '#6B8E23', '#32CD32', '#90EE90', '#98FB98'];
            } else if (urlLower.indexOf('space') !== -1 || urlLower.indexOf('galaxy') !== -1 || urlLower.indexOf('star') !== -1) {
                return ['#1B1B2F', '#162447', '#1F4068', '#E43F5A', '#E27D00', '#8A2BE2', '#4B0082', '#663399'];
            } else if (urlLower.indexOf('fire') !== -1 || urlLower.indexOf('red') !== -1) {
                return ['#DC143C', '#FF4500', '#FF6347', '#FF1493', '#B22222', '#8B0000', '#CD5C5C', '#F08080'];
            } else if (urlLower.indexOf('neon') !== -1 || urlLower.indexOf('bright') !== -1) {
                return ['#00FFFF', '#FF00FF', '#FFFF00', '#00FF00', '#FF6600', '#FF0080', '#8000FF', '#0080FF'];
            } else {
                return ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#74B9FF', '#FD79A8'];
            }
        }

        function displayImageColors(colors) {
            var container = document.getElementById('imageColors');
            var row = document.getElementById('imageColorsRow');
            
            if (colors.length === 0) {
                row.style.display = 'none';
                return;
            }
            
            container.innerHTML = '';
            row.style.display = 'flex';
            
            for (var i = 0; i < colors.length; i++) {
                var color = colors[i];
                var colorDiv = document.createElement('div');
                colorDiv.className = 'recent-color';
                colorDiv.onclick = function(c) {
                    return function() { applyImageColor(c); };
                }(color);
                
                var swatch = document.createElement('div');
                swatch.className = 'recent-color-swatch';
                swatch.style.backgroundColor = color;
                
                var hex = document.createElement('div');
                hex.className = 'recent-color-hex';
                hex.textContent = color;
                
                colorDiv.appendChild(swatch);
                colorDiv.appendChild(hex);
                container.appendChild(colorDiv);
            }
        }

        function applyImageColor(color) {
            document.getElementById('hexInput').value = color;
            document.getElementById('colorPicker').value = color.toLowerCase();
            addToRecentColors(color);
            applyTextColor();
        }

        function setColorStatus(message) {
            var statusElement = document.getElementById('colorStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        // Color management
        function addToRecentColors(color) {
            if (!color.startsWith('#')) color = '#' + color;
            color = color.toUpperCase();
            
            recentColors = recentColors.filter(function(c) { return c !== color; });
            recentColors.unshift(color);
            
            if (recentColors.length > 8) {
                recentColors = recentColors.slice(0, 8);
            }
            
            updateRecentColorsDisplay();
        }

        function updateRecentColorsDisplay() {
            var container = document.getElementById('recentColors');
            container.innerHTML = '';
            
            for (var i = 0; i < recentColors.length; i++) {
                var color = recentColors[i];
                var recentColor = document.createElement('div');
                recentColor.className = 'recent-color';
                recentColor.onclick = function(c) {
                    return function() { applyRecentColor(c); };
                }(color);
                
                var swatch = document.createElement('div');
                swatch.className = 'recent-color-swatch';
                swatch.style.backgroundColor = color;
                
                var hex = document.createElement('div');
                hex.className = 'recent-color-hex';
                hex.textContent = color;
                
                recentColor.appendChild(swatch);
                recentColor.appendChild(hex);
                container.appendChild(recentColor);
            }
        }

        function applyRecentColor(color) {
            document.getElementById('hexInput').value = color;
            document.getElementById('colorPicker').value = color.toLowerCase();
            applyTextColor();
        }

        // Color picker sync
        function updateColorFromHex() {
            var hex = document.getElementById('hexInput').value;
            if (/^#[0-9A-F]{6}$/i.test(hex)) {
                document.getElementById('colorPicker').value = hex.toLowerCase();
            }
        }

        function updateHexFromColor() {
            var color = document.getElementById('colorPicker').value;
            document.getElementById('hexInput').value = color.toUpperCase();
        }

        function updateGradientStartFromHex() {
            var hex = document.getElementById('gradientStartHex').value;
            if (/^#[0-9A-F]{6}$/i.test(hex)) {
                document.getElementById('gradientStart').value = hex.toLowerCase();
            }
        }

        function updateGradientStartHex() {
            var color = document.getElementById('gradientStart').value;
            document.getElementById('gradientStartHex').value = color.toUpperCase();
        }

        function updateGradientEndFromHex() {
            var hex = document.getElementById('gradientEndHex').value;
            if (/^#[0-9A-F]{6}$/i.test(hex)) {
                document.getElementById('gradientEnd').value = hex.toLowerCase();
            }
        }

        function updateGradientEndHex() {
            var color = document.getElementById('gradientEnd').value;
            document.getElementById('gradientEndHex').value = color.toUpperCase();
        }

        function swapGradientColors() {
            var startHex = document.getElementById('gradientStartHex').value;
            var startColor = document.getElementById('gradientStart').value;
            var endHex = document.getElementById('gradientEndHex').value;
            var endColor = document.getElementById('gradientEnd').value;
            
            document.getElementById('gradientStartHex').value = endHex;
            document.getElementById('gradientStart').value = endColor;
            document.getElementById('gradientEndHex').value = startHex;
            document.getElementById('gradientEnd').value = startColor;
        }

        // Symbol filtering
        function filterSymbols() {
            var searchTerm = document.getElementById('symbolSearch').value.toLowerCase();
            var symbolPicker = document.getElementById('symbolPicker');
            var options = symbolPicker.querySelectorAll('option');
            var optgroups = symbolPicker.querySelectorAll('optgroup');
            
            if (!searchTerm) {
                for (var i = 0; i < options.length; i++) {
                    options[i].style.display = '';
                }
                for (var i = 0; i < optgroups.length; i++) {
                    optgroups[i].style.display = '';
                }
                return;
            }
            
            for (var i = 0; i < optgroups.length; i++) {
                optgroups[i].style.display = 'none';
            }
            
            for (var i = 0; i < options.length; i++) {
                var option = options[i];
                if (option.value === '') {
                    option.style.display = '';
                    continue;
                }
                
                var keywords = option.dataset.keywords || '';
                var text = option.textContent.toLowerCase();
                var value = option.value.toLowerCase();
                
                var matches = keywords.indexOf(searchTerm) !== -1 || 
                             text.indexOf(searchTerm) !== -1 || 
                             value.indexOf(searchTerm) !== -1;
                
                if (matches) {
                    option.style.display = '';
                    var parentGroup = option.closest('optgroup');
                    if (parentGroup) {
                        parentGroup.style.display = '';
                    }
                } else {
                    option.style.display = 'none';
                }
            }
        }

        function insertSymbol() {
            var symbol = document.getElementById('symbolPicker').value;
            if (symbol) {
                visualEditor.focus();
                
                var selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    var range = selection.getRangeAt(0);
                    range.deleteContents();
                    
                    var textNode = document.createTextNode(symbol);
                    range.insertNode(textNode);
                    
                    range.setStartAfter(textNode);
                    range.setEndAfter(textNode);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
                
                updateBBCodeOutput();
                
                setTimeout(function() {
                    document.getElementById('symbolPicker').value = '';
                }, 100);
            }
            visualEditor.focus();
        }

        // BBCode conversion
        function htmlToBBCode(html) {
            var bbcode = html;
            
            bbcode = bbcode.replace(/<img[^>]*src="([^"]*)"[^>]*>/gi, '[img]$1[/img]');
            bbcode = bbcode.replace(/<span[^>]*data-gradient-letter="([^"]*)"[^>]*>([^<]*)<\/span>/gi, '[color=$1]$2[/color]');
            bbcode = bbcode.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '[b]$1[/b]');
            bbcode = bbcode.replace(/<b[^>]*>(.*?)<\/b>/gi, '[b]$1[/b]');
            bbcode = bbcode.replace(/<em[^>]*>(.*?)<\/em>/gi, '[i]$1[/i]');
            bbcode = bbcode.replace(/<i[^>]*>(.*?)<\/i>/gi, '[i]$1[/i]');
            bbcode = bbcode.replace(/<u[^>]*>(.*?)<\/u>/gi, '[u]$1[/u]');
            bbcode = bbcode.replace(/<s[^>]*>(.*?)<\/s>/gi, '[s]$1[/s]');
            bbcode = bbcode.replace(/<span style="color:\s*([^;"]+)[^"]*"[^>]*>(.*?)<\/span>/gi, '[color=$1]$2[/color]');
            bbcode = bbcode.replace(/<font color="([^"]*)"[^>]*>(.*?)<\/font>/gi, '[color=$1]$2[/color]');
            bbcode = bbcode.replace(/<div[^>]*>/gi, '');
            bbcode = bbcode.replace(/<\/div>/gi, '\n');
            bbcode = bbcode.replace(/<br[^>]*>/gi, '\n');
            bbcode = bbcode.replace(/<[^>]*>/g, '');
            bbcode = bbcode.replace(/\n{3,}/g, '\n\n').trim();
            
            return bbcode;
        }

        function updateBBCodeOutput() {
            var htmlContent = visualEditor.innerHTML;
            var bbcode = htmlToBBCode(htmlContent);
            document.getElementById('bbcodeOutput').textContent = bbcode || 'BBCode will appear here...';
        }

        function updateVisualEditor() {
            var bbcode = bbcodeInput.value;
            var htmlContent = bbcode
                .replace(/\[img\](.*?)\[\/img\]/gi, '<img src="$1" style="max-width:100%;height:auto;display:block;margin:10px 0;">')
                .replace(/\[b\](.*?)\[\/b\]/gi, '<strong>$1</strong>')
                .replace(/\[i\](.*?)\[\/i\]/gi, '<em>$1</em>')
                .replace(/\[u\](.*?)\[\/u\]/gi, '<u>$1</u>')
                .replace(/\[s\](.*?)\[\/s\]/gi, '<s>$1</s>')
                .replace(/\[color=([^\]]*)\](.*?)\[\/color\]/gi, '<span style="color:$1">$2</span>')
                .replace(/\n/g, '<br>');
            
            visualEditor.innerHTML = htmlContent;
            document.getElementById('bbcodeOutput').textContent = bbcode || 'BBCode will appear here...';
        }

        function updateToolbarState() {
            document.getElementById('boldBtn').classList.toggle('active', document.queryCommandState('bold'));
            document.getElementById('italicBtn').classList.toggle('active', document.queryCommandState('italic'));
            document.getElementById('underlineBtn').classList.toggle('active', document.queryCommandState('underline'));
            document.getElementById('strikeBtn').classList.toggle('active', document.queryCommandState('strikeThrough'));
        }

        function clearAllFormatting() {
            var allText = visualEditor.innerText || visualEditor.textContent || '';
            
            if (allText.trim()) {
                visualEditor.innerHTML = allText.replace(/\n/g, '<br>');
            } else {
                visualEditor.innerHTML = '<br>';
            }
            
            var imageColorsRow = document.getElementById('imageColorsRow');
            var imageColorsContainer = document.getElementById('imageColors');
            if (imageColorsRow && imageColorsContainer) {
                imageColorsRow.style.display = 'none';
                imageColorsContainer.innerHTML = '';
            }
            
            updateBBCodeOutput();
            visualEditor.focus();
        }

        function clearSelectedFormatting() {
            var selection = window.getSelection();
            if (!selection.rangeCount || selection.getRangeAt(0).collapsed) {
                alert('Please select some text first to remove formatting from it.');
                return;
            }

            document.execCommand('removeFormat');
            updateBBCodeOutput();
            visualEditor.focus();
        }

        function copyBBCode() {
            var bbcode = document.getElementById('bbcodeOutput').textContent;
            if (bbcode === 'BBCode will appear here...') return;

            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(bbcode).then(function() {
                        var btn = document.querySelector('.copy-btn');
                        var originalText = btn.textContent;
                        btn.textContent = '✅ Copied!';
                        setTimeout(function() {
                            btn.textContent = originalText;
                        }, 2000);
                    });
                } else {
                    throw new Error('Clipboard API not available');
                }
            } catch (err) {
                var textArea = document.createElement('textarea');
                textArea.value = bbcode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('BBCode copied to clipboard!');
            }
        }

        // Placeholder functions for missing features
        function handleEnterKey(event) {
            // Basic enter key handling
        }

        function transformCase(caseType) {
            var selection = window.getSelection();
            if (!selection.rangeCount || selection.getRangeAt(0).collapsed) {
                alert('Please select some text first to change its case.');
                return;
            }
            
            var range = selection.getRangeAt(0);
            var text = range.toString();
            var newText;
            
            switch(caseType) {
                case 'uppercase':
                    newText = text.toUpperCase();
                    break;
                case 'lowercase':
                    newText = text.toLowerCase();
                    break;
                case 'propercase':
                    newText = text.toLowerCase().replace(/\b\w/g, function(char) { return char.toUpperCase(); });
                    break;
                default:
                    newText = text;
            }
            
            range.deleteContents();
            range.insertNode(document.createTextNode(newText));
            updateBBCodeOutput();
            visualEditor.focus();
        }

        function applySubscript() {
            formatText('subscript');
        }

        function applySuperscript() {
            formatText('superscript');
        }

        function applyFontSize() {
            var size = document.getElementById('fontSize').value;
            if (size) {
                var selection = window.getSelection();
                if (!selection.rangeCount || selection.getRangeAt(0).collapsed) {
                    alert('Please select some text first to change its font size.');
                    document.getElementById('fontSize').value = '';
                    return;
                }
                
                var span = document.createElement('span');
                span.style.fontSize = size + 'px';
                
                var range = selection.getRangeAt(0);
                try {
                    range.surroundContents(span);
                } catch (e) {
                    var contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                }
                
                updateBBCodeOutput();
                visualEditor.focus();
            }
        }

        function applyFontFamily() {
            var fontFamily = document.getElementById('fontFamily').value;
            if (fontFamily) {
                var selection = window.getSelection();
                if (!selection.rangeCount || selection.getRangeAt(0).collapsed) {
                    alert('Please select some text first to change its font.');
                    document.getElementById('fontFamily').value = '';
                    return;
                }
                
                var span = document.createElement('span');
                span.style.fontFamily = fontFamily;
                
                var range = selection.getRangeAt(0);
                try {
                    range.surroundContents(span);
                } catch (e) {
                    var contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                }
                
                updateBBCodeOutput();
                visualEditor.focus();
            }
        }

        // Initialize
        visualEditor.focus();
        updateBBCodeOutput();
        
        document.getElementById('hexInput').value = '#000000';
        document.getElementById('gradientStartHex').value = '#FF0000';
        document.getElementById('gradientEndHex').value = '#0000FF';
        
        document.addEventListener('selectionchange', function() {
            var selection = window.getSelection();
            if (selection.rangeCount > 0) {
                var range = selection.getRangeAt(0);
                if (visualEditor.contains(range.commonAncestorContainer) || 
                    range.commonAncestorContainer === visualEditor) {
                    updateToolbarState();
                }
            }
        });
        
        document.getElementById('imageUrl').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                insertImage();
            }
        });
    </script>
</body>
</html>
