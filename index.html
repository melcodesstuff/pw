<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PW Post Averages</title>
  <!-- Tailwind for styling (CDN, fine for prototypes) -->
  <link rel="icon" type="image/png" href="witch-hat.png">

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <!-- React 18 + ReactDOM UMD (no build step needed) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel Standalone to transpile JSX in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // ---------------- Utilities ----------------
    const todayISO = () => new Date().toISOString().slice(0, 10);
    function parseISO(s) { const [y, m, d] = s.split("-").map(Number); return new Date(y, m - 1, d); }
    function addYears(d, n) { const x = new Date(d); x.setFullYear(x.getFullYear() + n); return x; }
    function uid() { return Math.random().toString(36).slice(2, 9); }
    function clampInt(n, min, max) { const v = typeof n === "number" ? n : parseInt(String(n || 0), 10); if (Number.isNaN(v)) return min; return Math.max(min, Math.min(max, v)); }
    function formatAvg(n) { if (n == null || Number.isNaN(n)) return "—"; return Number.isInteger(n) ? String(n) : n.toFixed(2); }
    const dayMs = 24 * 60 * 60 * 1000;
    function daysInclusive(a, b) { return Math.round((parseISO(b) - parseISO(a)) / dayMs) + 1; }

    // ------------- TERM MAP (subset) -------------
    const TERM_MAP = {
      167: { start: "2024-02-24", end: "2024-04-05" },
      168: { start: "2024-04-06", end: "2024-05-17" },
      169: { start: "2024-05-18", end: "2024-06-29" },
      170: { start: "2024-07-06", end: "2024-08-16" },
      171: { start: "2024-08-17", end: "2024-09-28" },
      172: { start: "2024-10-05", end: "2024-11-15" },
      173: { start: "2024-11-16", end: "2024-12-28" },
      174: { start: "2025-01-04", end: "2025-02-14" },
      175: { start: "2025-02-15", end: "2025-03-28" },
      176: { start: "2025-04-05", end: "2025-05-16" },
      177: { start: "2025-05-17", end: "2025-06-28" },
      178: { start: "2025-07-05", end: "2025-08-15" },
    };

    // tiny badge helper
    function Badge({ ok, pending=false, children }) {
      const base = 'inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border';
      const cls = pending
        ? 'bg-slate-100 text-slate-700 border-slate-200'
        : ok
          ? 'bg-emerald-100 text-emerald-900 border-emerald-200'
          : 'bg-rose-100 text-rose-900 border-rose-200';
      return <span className={`${base} ${cls}`}>{children}</span>;
    }

    // ---------------- App ----------------
    function App() {
      // Follow system dark mode (no toggle UI)
      useEffect(() => {
        const mq = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)");
        const apply = () => {
          if (mq && mq.matches) document.documentElement.classList.add("dark");
          else document.documentElement.classList.remove("dark");
        };
        apply();
        mq && mq.addEventListener && mq.addEventListener("change", apply);
        return () => { mq && mq.removeEventListener && mq.removeEventListener("change", apply); };
      }, []);

      const today = todayISO();
      const currentTerm = useMemo(() => {
        const td = parseISO(today);
        for (const [tStr, range] of Object.entries(TERM_MAP)) {
          const t = Number(tStr);
          const s = parseISO(range.start);
          const e = parseISO(range.end);
          if (td >= s && td <= e) return t;
        }
        return Math.max(...Object.keys(TERM_MAP).map(Number));
      }, [today]);

      function blankChar() {
        return {
          id: uid(),
          name: "",
          joinedTerm: "",
          isAdultCreated: false,
          isSpirit: false,
          currentPosts: "",
          graduationCount: "",
          hasAdultCheck: false,
          adultCheckTerm: "",
          adultCheckPostCount: "",
        };
      }

      const [characters, setCharacters] = useState([blankChar(), blankChar()]);
      const [showTerms, setShowTerms] = useState(false);
      const [sortBy, setSortBy] = useState('term'); // 'term' | 'start' | 'end'
      const [sortDir, setSortDir] = useState('desc'); // 'asc' | 'desc'

      function updateChar(id, patch) { setCharacters(prev => prev.map(c => (c.id === id ? { ...c, ...patch } : c))); }
      function addChar() { if (characters.length >= 10) return; setCharacters(prev => [...prev, blankChar()]); }
      function removeChar(id) { setCharacters(prev => prev.filter(c => c.id !== id)); }
      function clearChar(id) { setCharacters(prev => prev.map(c => c.id === id ? blankChar() : c)); }
      function clearAll() { setCharacters([blankChar(), blankChar()]); }

      function computeChar(c) {
        let termsOnBoard = null;
        if (typeof c.joinedTerm === "number") {
          termsOnBoard = currentTerm - c.joinedTerm + 1;
          if (termsOnBoard < 1) termsOnBoard = null;
        }

        // Hogwarts vs AW
        let stage = "";
        let hogwartsYear = null;
        let awTerms = null;
        if (typeof c.joinedTerm === "number") {
          if (c.isAdultCreated) {
            stage = "AW";
            awTerms = termsOnBoard ?? null;
          } else if (termsOnBoard != null) {
            if (termsOnBoard <= 7) { stage = "Hogwarts"; hogwartsYear = termsOnBoard; }
            else { stage = "AW"; awTerms = termsOnBoard - 7; }
          }
        }

        // 2+ RL years conservative rule
        let twoPlusYears = false, twoPlusAmbiguous = false;
        if (typeof c.joinedTerm === "number" && TERM_MAP[c.joinedTerm]) {
          const { start, end } = TERM_MAP[c.joinedTerm];
          const start2y = addYears(parseISO(start), 2);
          const end2y = addYears(parseISO(end), 2);
          const td = parseISO(today);
          if (td >= end2y) twoPlusYears = true;
          else if (td >= start2y && td < end2y) twoPlusAmbiguous = true;
        }
        const minRequired = c.isSpirit ? 0 : (twoPlusYears ? 10 : 20);

        const posts = c.currentPosts === "" ? null : Number(c.currentPosts);
        const perTermAvg = (posts != null && termsOnBoard && termsOnBoard > 0) ? (posts / termsOnBoard) : null;
        const meetsMinimum = perTermAvg == null ? null : perTermAvg >= minRequired;

        const grad = typeof c.graduationCount === "number" ? Number(c.graduationCount) : null;
        const hogwartsAvgPerTerm = grad != null ? grad / 7 : null;
        const awAvgPerTerm = (stage === "AW" && grad != null && posts != null && awTerms && awTerms > 0 && posts >= grad)
          ? (posts - grad) / awTerms : null;

        let sinceAdultCheckAvg = null;
        if (stage === "AW" && c.hasAdultCheck && typeof c.adultCheckTerm === "number" && typeof c.adultCheckPostCount === "number" && posts != null) {
          const termsSince = Math.max(1, currentTerm - c.adultCheckTerm + 1);
          const delta = posts - c.adultCheckPostCount;
          if (termsSince > 0 && delta >= 0) sinceAdultCheckAvg = delta / termsSince;
        }

        return { termsOnBoard, stage, hogwartsYear, awTerms, twoPlusYears, twoPlusAmbiguous, minRequired, perTermAvg, meetsMinimum, hogwartsAvgPerTerm, awAvgPerTerm, sinceAdultCheckAvg };
      }

      const computed = useMemo(() => {
        const map = {}; characters.forEach(c => { map[c.id] = computeChar(c); }); return map;
      }, [characters, currentTerm, today]);

      const totals = useMemo(() => {
        const count = characters.length;
        const perTermAverages = characters.map(c => computed[c.id]?.perTermAvg ?? 0);
        const avg = count ? perTermAverages.reduce((a,b)=>a+b,0) / count : 0;
        const requiredTotal = characters.reduce((s,c)=> s + (computed[c.id]?.minRequired || 0), 0);
        const allHavePosts = characters.every(c => c.currentPosts !== "");
        const overallOk = avg >= 20 || !allHavePosts;
        const perCharOk = characters.every(c => {
          const pc = computed[c.id];
          if (!pc) return true;
          if (c.currentPosts === "" || pc.perTermAvg == null) return true;
          return pc.meetsMinimum ?? true;
        });
        const eligible = perCharOk && overallOk && characters.some(c => c.currentPosts !== "");

        // who is below minimum
        const belowList = characters
          .map(c => ({ c, pc: computed[c.id] }))
          .filter(({ c, pc }) => c.currentPosts !== "" && pc && pc.perTermAvg != null && pc.minRequired > 0 && pc.perTermAvg < pc.minRequired)
          .map(({ c, pc }) => ({
            id: c.id,
            name: c.name || "(unnamed)",
            required: pc.minRequired,
            avg: pc.perTermAvg,
            shortfall: Math.max(0, pc.minRequired - pc.perTermAvg),
            twoPlusAmbiguous: pc.twoPlusAmbiguous
          }));

        let overallNeededPerChar = 0;
        if (allHavePosts) overallNeededPerChar = Math.max(0, 20 - avg);

        return { count, avg, requiredTotal, eligible, allHavePosts, overallOk, perCharOk, belowList, overallNeededPerChar };
      }, [characters, computed]);

      // Terms table data
      const termRows = useMemo(() => {
        const rows = Object.entries(TERM_MAP).map(([term, { start, end }]) => ({
          term: Number(term), start, end, days: daysInclusive(start, end)
        }));
        const dir = sortDir === 'asc' ? 1 : -1;
        return rows.sort((a,b) => {
          if (sortBy === 'term') return (a.term - b.term) * dir;
          if (sortBy === 'start') return (parseISO(a.start) - parseISO(b.start)) * dir;
          if (sortBy === 'end') return (parseISO(a.end) - parseISO(b.end)) * dir;
          return 0;
        });
      }, [sortBy, sortDir]);

      const sortHeader = (key) => {
        if (sortBy === key) setSortDir(d => d === 'asc' ? 'desc' : 'asc');
        else { setSortBy(key); setSortDir('asc'); }
      };

      return (
        <div className="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100">
          <div className="max-w-6xl mx-auto px-6 py-10">
            <header className="mb-6 flex flex-col md:flex-row md:items-end md:justify-between gap-3">
              <div>
                <h1 className="text-3xl font-semibold leading-tight">PW Post Averages</h1>
                <p className="mt-2 text-base text-slate-600 dark:text-slate-400">Unofficial calculator for per-term averages.</p>
              </div>
              <div className="flex gap-2">
                <button onClick={() => setShowTerms(true)} className="px-3 py-2.5 rounded-xl bg-slate-900 text-white dark:bg-slate-200 dark:text-slate-900">Term dates</button>
              </div>
            </header>

            {/* Context */}
            <section className="grid grid-cols-1 md:grid-cols-3 gap-6 bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-sm border border-slate-200/50 dark:border-slate-700/50 mb-8">
              <div><div className="text-xs uppercase tracking-wide text-slate-500">Today</div><div className="mt-1 text-lg font-medium">{today}</div></div>
              <div><div className="text-xs uppercase tracking-wide text-slate-500">Current term</div><div className="mt-1 text-lg font-medium">{currentTerm}</div></div>
              <div className="text-xs text-slate-500 md:col-span-1 col-span-3">Based on embedded PW timeline for recent terms.</div>
            </section>

            {/* Characters */}
            <div className="space-y-6">
              {characters.map((c, idx) => {
                const pc = computed[c.id];
                const inAW = pc?.stage === "AW";
                const showGradField = inAW && !c.isAdultCreated;
                const below = (c.currentPosts !== "" && pc && pc.meetsMinimum === false);
                return (
                  <section key={c.id} className={`relative rounded-2xl border p-6 shadow-sm bg-white dark:bg-slate-800 border-slate-200/60 dark:border-slate-700/50`}>
                    <div className="absolute right-5 top-5 text-xs text-slate-500">{below ? <span className="text-rose-500 font-medium">Below minimum</span> : <span>Character {idx + 1}</span>}</div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                      <div>
                        <label className="text-xs uppercase tracking-wide text-slate-500">Character name</label>
                        <input value={c.name} onChange={e => updateChar(c.id, { name: e.target.value })} className="w-full mt-1 px-3 h-11 rounded-xl bg-slate-100 dark:bg-slate-700 outline-none" />
                      </div>

                      <div>
                        <label className="text-xs uppercase tracking-wide text-slate-500">What term did they join?</label>
                        <input type="number" value={c.joinedTerm} onChange={e => updateChar(c.id, { joinedTerm: e.target.value === "" ? "" : clampInt(e.target.value, 1, 999) })} className="w-full mt-1 px-3 h-11 rounded-xl bg-slate-100 dark:bg-slate-700 outline-none" />
                        <p className="text-xs mt-1 text-slate-500">Terms on board: <span className="font-medium">{pc?.termsOnBoard ?? "—"}</span></p>
                      </div>

                      <div className="flex items-end gap-4">
                        <label className="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300"><input type="checkbox" className="accent-indigo-600" checked={c.isAdultCreated} onChange={e => updateChar(c.id, { isAdultCreated: e.target.checked })}/> Adult character</label>
                        <label className="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300"><input type="checkbox" className="accent-indigo-600" checked={c.isSpirit} onChange={e => updateChar(c.id, { isSpirit: e.target.checked })}/> Spirit character</label>
                      </div>

                      {/* Hogwarts / AW status (auto) removed field box per request; logic remains in summary */}

                      <div>
                        <label className="text-xs uppercase tracking-wide text-slate-500">Current post count</label>
                        <input type="number" value={c.currentPosts} onChange={e => updateChar(c.id, { currentPosts: e.target.value === "" ? "" : clampInt(e.target.value, 0, 1000000) })} className="w-full mt-1 px-3 h-11 rounded-xl bg-slate-100 dark:bg-slate-700 outline-none" />
                        <div className="text-xs mt-1 text-slate-500">Minimum required: <span className="font-medium">{pc?.minRequired ?? "—"}</span>{pc?.perTermAvg != null && <> • Your avg: <span className="font-medium">{formatAvg(pc.perTermAvg)}</span></>}{pc?.twoPlusAmbiguous && <span className="ml-2 px-1.5 py-0.5 rounded bg-amber-200 text-amber-900">check 2y date</span>}</div>
                      </div>

                      {showGradField && (
                        <div>
                          <label className="text-xs uppercase tracking-wide text-slate-500">Graduation post count (end of Hogwarts)</label>
                          <input type="number" value={c.graduationCount} onChange={e => updateChar(c.id, { graduationCount: e.target.value === "" ? "" : clampInt(e.target.value, 0, 1000000) })} className="w-full mt-1 px-3 h-11 rounded-xl bg-slate-100 dark:bg-slate-700 outline-none" />
                        </div>
                      )}

                      {inAW && (
                        <>
                          <div>
                            <label className="text-xs uppercase tracking-wide text-slate-500">{c.isAdultCreated ? 'Adult check after registration?' : 'Adult check after graduation?'}</label>
                            <select value={c.hasAdultCheck ? "yes" : "no"} onChange={e => updateChar(c.id, { hasAdultCheck: e.target.value === "yes", adultCheckTerm: e.target.value === "yes" ? c.adultCheckTerm : "", adultCheckPostCount: e.target.value === "yes" ? c.adultCheckPostCount : "" })} className="w-full mt-1 px-3 h-11 rounded-xl bg-slate-100 dark:bg-slate-700 outline-none"><option value="no">No</option><option value="yes">Yes</option></select>
                          </div>
                          {c.hasAdultCheck && (
                            <>
                              <div>
                                <label className="text-xs uppercase tracking-wide text-slate-500">Adult check term</label>
                                <input type="number" value={c.adultCheckTerm} onChange={e => updateChar(c.id, { adultCheckTerm: e.target.value === "" ? "" : clampInt(e.target.value, 1, 999) })} className="w-full mt-1 px-3 h-11 rounded-xl bg-slate-100 dark:bg-slate-700 outline-none" />
                              </div>
                              <div>
                                <label className="text-xs uppercase tracking-wide text-slate-500">Adult check post count</label>
                                <input type="number" value={c.adultCheckPostCount} onChange={e => updateChar(c.id, { adultCheckPostCount: e.target.value === "" ? "" : clampInt(e.target.value, 0, 1000000) })} className="w-full mt-1 px-3 h-11 rounded-xl bg-slate-100 dark:bg-slate-700 outline-none" />
                              </div>
                            </>
                          )}
                        </>
                      )}
                    </div>

                    {/* Per-character Summary */}
                    <div className="mt-5 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200/60 dark:border-slate-700/50 p-4 text-sm">
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><div className="text-slate-500">Terms on board</div><div className="font-medium">{pc?.termsOnBoard ?? "—"}</div></div>
                        <div><div className="text-slate-500">AW terms</div><div className="font-medium">{pc?.awTerms ?? 0}</div></div>
                        <div><div className="text-slate-500">Posts overall</div><div className="font-medium">{c.currentPosts === "" ? "—" : c.currentPosts}</div></div>
                        <div><div className="text-slate-500">Overall avg/term</div><div className="font-medium">{pc?.perTermAvg != null ? formatAvg(pc.perTermAvg) : "—"}</div></div>
                        <div><div className="text-slate-500">Hogwarts avg/term</div><div className="font-medium">{pc?.hogwartsAvgPerTerm != null ? formatAvg(pc.hogwartsAvgPerTerm) : "—"}</div></div>
                        <div><div className="text-slate-500">AW avg/term</div><div className="font-medium">{pc?.awAvgPerTerm != null ? formatAvg(pc.awAvgPerTerm) : "—"}</div></div>
                        {pc?.sinceAdultCheckAvg != null && (
                          <div className="md:col-span-3"><div className="text-slate-500">Since adult check avg/term</div><div className="font-medium">{formatAvg(pc.sinceAdultCheckAvg)}</div></div>
                        )}
                      </div>
                    </div>

                    <div className="mt-4 flex flex-wrap gap-2 justify-end items-center">
                      <div className="flex gap-2">
                        <button onClick={() => clearChar(c.id)} className="px-3 py-2 rounded-xl bg-slate-200 dark:bg-slate-700">Clear</button>
                        <button onClick={() => removeChar(c.id)} className="px-3 py-2 rounded-xl bg-slate-200 dark:bg-slate-700">Remove</button>
                      </div>
                    </div>
                  </section>
                );
              })}

              <div className="flex gap-3 items-center">
                <button onClick={addChar} disabled={characters.length >= 10} className="px-4 py-2.5 rounded-xl bg-indigo-600 text-white disabled:opacity-40">Add character</button>
                <div className="text-sm text-slate-500">{characters.length}/10</div>
                <button onClick={clearAll} className="ml-auto px-4 py-2.5 rounded-xl bg-rose-600 text-white">Clear all</button>
              </div>
            </div>

            {/* Summary */}
            <section className="mt-8 rounded-2xl border p-6 shadow-sm bg-white dark:bg-slate-800 border-slate-200/60 dark:border-slate-700/50">
              <h2 className="text-xl font-semibold mb-3">Summary</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <div className="space-y-2">
                  {/* Total characters */}
                  <div>Total characters: <span className="font-medium">{characters.length}</span></div>

                  {/* Per-character lines */}
                  <div className="space-y-1">
                    {characters.map((c) => {
                      const pc = computed[c.id];
                      const label = c.name ? c.name : '(unnamed)';
                      const avgStr = pc?.perTermAvg != null ? formatAvg(pc.perTermAvg) : '—';
                      return (
                        <div key={c.id}>
                          {label} average: <span className="font-medium">{avgStr}</span> <span className="text-slate-500">posts/term</span>
                        </div>
                      );
                    })}
                  </div>

                  {/* Overall average */}
                  <div>Overall average: <span className="font-medium">{formatAvg((() => {
                    const count = characters.length;
                    const avgs = characters.map(c => (computed[c.id]?.perTermAvg ?? 0));
                    return count ? avgs.reduce((a,b)=>a+b,0)/count : 0;
                  })())}</span> <span className="text-slate-500">posts/term</span></div>
                </div>

                {/* Rules */}
                <div className="space-y-2">
                  <div className="text-slate-600 dark:text-slate-300">Calculator uses the following rules:</div>
                  <ul className="list-disc pl-5 space-y-1 text-slate-700 dark:text-slate-300">
                    <li>Under 2 RL years: ≥ 20/term.</li>
                    <li>2+ RL years: ≥ 10/term. <em>(If your 2‑year date is close, it will default to 20 and flag it to double‑check.)</em></li>
                    <li>Spirits have no per‑character minimum.</li>
                    <li>Overall average must be ≥ 20.</li>
                  </ul>
                </div>
              </div>
            </section>
          </div>

          {/* --- Modal: Term Dates --- */}
          {showTerms && (
            <div className="fixed inset-0 z-50">
              <div className="absolute inset-0 bg-black/40" onClick={() => setShowTerms(false)}></div>
              <div className="absolute inset-0 flex items-center justify-center p-4">
                <div className="w-full max-w-3xl rounded-2xl bg-white dark:bg-slate-800 shadow-xl border border-slate-200/60 dark:border-slate-700/50">
                  <div className="px-5 py-4 flex items-center justify-between border-b border-slate-200/60 dark:border-slate-700/50">
                    <h3 className="text-lg font-semibold">PW term dates</h3>
                    <button className="px-2 py-1 text-sm rounded-lg bg-slate-100 dark:bg-slate-700" onClick={() => setShowTerms(false)}>Close</button>
                  </div>
                  <div className="p-5 overflow-auto max-h-[70vh]">
                    <div className="mb-3 text-xs text-slate-500">Click a header to sort</div>
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="text-left text-slate-600 dark:text-slate-300">
                          <th className="py-2 cursor-pointer" onClick={() => sortHeader('term')}>Term {sortBy==='term' ? (sortDir==='asc' ? '↑' : '↓') : ''}</th>
                          <th className="py-2 cursor-pointer" onClick={() => sortHeader('start')}>Start {sortBy==='start' ? (sortDir==='asc' ? '↑' : '↓') : ''}</th>
                          <th className="py-2 cursor-pointer" onClick={() => sortHeader('end')}>End {sortBy==='end' ? (sortDir==='asc' ? '↑' : '↓') : ''}</th>
                          <th className="py-2">Days</th>
                        </tr>
                      </thead>
                      <tbody>
                        {termRows.map(r => (
                          <tr key={r.term} className="border-t border-slate-100 dark:border-slate-700/50">
                            <td className="py-2 font-medium">{r.term}</td>
                            <td className="py-2">{r.start}</td>
                            <td className="py-2">{r.end}</td>
                            <td className="py-2">{r.days}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
